<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° - ì •í™•í•œ í‰ê· ë‹¨ê°€ ë° íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° (Ver.2.6)</title>
  <meta name="description" content="ì£¼ì‹, ì½”ì¸ íˆ¬ì ì‹œ ë¬¼íƒ€ê¸°(ì¶”ê°€ë§¤ìˆ˜)ë¡œ ë³€í•˜ëŠ” í‰ê·  ë§¤ìˆ˜ë‹¨ê°€, ì´ íˆ¬ìê¸ˆì•¡, ì˜ˆìƒ ìˆ˜ìµë¥  ë° ì†ìµë¶„ê¸°ì ì„ ê°„í¸í•˜ê²Œ ê³„ì‚°í•˜ê³  ì‹œê°í™”ëœ ì°¨íŠ¸ë¡œ í™•ì¸í•˜ì„¸ìš”. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •, ì „ì¼ ì¢…ê°€ ì¡°íšŒ ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤.">
  <link rel="canonical" href="https://rosfe12.github.io/" />
  <link href="https://fonts.googleapis.com/2024/2/af/4172776366-2.webp?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest/dist/chartjs-plugin-annotation.min.js"></script> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° - íˆ¬ì ìˆ˜ìµë¥  ë° í‰ê· ë‹¨ê°€ ê³„ì‚°",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "KRW" },
    "description": "ì£¼ì‹, ì½”ì¸ íˆ¬ì ì‹œ ì¶”ê°€ ë§¤ìˆ˜(ë¬¼íƒ€ê¸°)ë¥¼ í†µí•´ í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ë¥¼ ë‚®ì¶”ê³  íˆ¬ì ìˆ˜ìµë¥ , ì†ìµë¶„ê¸°ì ì„ ê³„ì‚°í•˜ëŠ” ì›¹ ê³„ì‚°ê¸°ì…ë‹ˆë‹¤. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •, ì „ì¼ ì¢…ê°€ ì¡°íšŒ(ì¢…ëª©ëª…/ì½”ë“œ ê²€ìƒ‰), ë‹¤ì–‘í•œ ì°¨íŠ¸ ì‹œê°í™”ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
    "url": "https://rosfe12.github.io/",
    "keywords": "ë¬¼íƒ€ê¸° ê³„ì‚°ê¸°, ì£¼ì‹ ê³„ì‚°ê¸°, ì½”ì¸ ê³„ì‚°ê¸°, í‰ê· ë‹¨ê°€ ê³„ì‚°ê¸°, í‰ë‹¨ê°€ ê³„ì‚°ê¸°, íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚°ê¸°, ìˆ˜ìµë¥  ê³„ì‚°ê¸°, ì†ìµë¶„ê¸°ì  ê³„ì‚°ê¸°, ì¶”ê°€ë§¤ìˆ˜ ê³„ì‚°ê¸°, ì£¼ì‹ ì‹œì„¸ ì¡°íšŒ, KRX ì‹œì„¸, ì¢…ëª©ëª… ê²€ìƒ‰"
  }
  </script>
  </head>

  <style>
    body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; max-width: 800px; margin: auto; transition: background-color 0.3s, color 0.3s; }
    section { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, button { margin: 5px 0; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    button { background-color: #4CAF50; color: white; cursor: pointer; border: none; }
    button:hover { opacity: 0.9; }
    button.secondary { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
    table, th, td { border: 1px solid #ccc; }
    th { background: #f2f2f2; white-space: nowrap; }
    td, th { padding: 6px; text-align: center; }
    .positive { color: red; font-weight: bold; }
    .negative { color: blue; font-weight: bold; }
    canvas { margin-top: 20px; max-width: 100%; }
    .buy-block { margin-bottom: 10px; padding: 10px; border: 1px dashed #aaa; border-radius: 6px; background: #f9f9f9; }
    body.dark { background-color: #121212; color: #e0e0e0; }
    body.dark section { background-color: #1e1e1e; border-color: #444; }
    body.dark input, body.dark button.secondary { background-color: #2c2c2c; color: #fff; border: 1px solid #555; }
    body.dark table, body.dark th, body.dark td { border-color: #555; }
    body.dark th { background-color: #2a2a2a; }
    body.dark .buy-block { background-color: #2a2a2a; border-color: #555; }
    .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 5px; color: white; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-size: 0.9em; }
    .notification.show { opacity: 1; bottom: 30px; }
    .notification.success { background-color: #4CAF50; }
    .notification.error { background-color: #f44336; }
    .notification.info { background-color: #2196F3; }
    .input-group { display: flex; gap: 10px; align-items: center; }
    .input-group label { flex-basis: 120px; margin-top: 0; }
    .input-group input { flex-grow: 1; }
    #purchaseHistoryTableContainer table td, #purchaseHistoryTableContainer table th { font-size: 0.85em; padding: 5px;}
    .intro-text { text-align: left; margin-bottom: 25px; padding: 10px 0; line-height: 1.6; font-size: 0.95em;}
    body.dark .intro-text { color: #c0c0c0; }
    @media (max-width: 600px) {
      body { padding: 10px; } section { padding: 10px; } h1 { font-size: 1.5em; } h3 { font-size: 1.1em; }
      input, button { font-size: 1em; padding: 12px 10px; } button { margin-top: 8px; }
      table td, table th { font-size: 0.8em; padding: 4px; }
      #purchaseHistoryTableContainer table td, #purchaseHistoryTableContainer table th { font-size: 0.75em; padding: 3px;}
      canvas { height: auto !important; } .input-group { flex-direction: column; align-items: stretch; }
      .input-group label { flex-basis: auto; margin-bottom: 5px; } .intro-text { font-size: 0.9em; }
    }
  </style>
</head>
<body>

<h1 style="text-align: center;">ğŸ’¸ ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° Ver.2.6: íˆ¬ì ìˆ˜ìµë¥  & í‰ê· ë‹¨ê°€ ë¶„ì„</h1>
<div style="text-align: right; margin-bottom: 10px;">
  <button id="darkModeBtn" onclick="toggleDarkMode()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON</button>
</div>
<div class="intro-text">
    ë³¸ ê³„ì‚°ê¸°ëŠ” ìµœì´ˆ ë§¤ìˆ˜ ë° ì—¬ëŸ¬ ì°¨ë¡€ì˜ ì¶”ê°€ ë§¤ìˆ˜ ì‹œ ë³€ë™ë˜ëŠ” <strong>í‰ê·  ë‹¨ê°€, ì´ íˆ¬ìê¸ˆì•¡, ì˜ˆìƒ ìˆ˜ìµë¥ , ê·¸ë¦¬ê³  ë§¤ìš° ì¤‘ìš”í•œ ì†ìµë¶„ê¸°ì (BEP)</strong> ë“±ì„ ì†ì‰½ê²Œ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.<br>
    ë˜í•œ, ì…ë ¥ëœ ë§¤ìˆ˜ ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ <strong>í‰ê·  ë‹¨ê°€ ë³€ë™ ì¶”ì´, íšŒì°¨ë³„ ë§¤ìˆ˜ëŸ‰, ë§¤ìˆ˜ ê¸ˆì•¡ ë¹„ì¤‘</strong>ì„ ì§ê´€ì ì¸ ì°¨íŠ¸ë¡œ ì‹œê°í™”í•˜ì—¬ íˆ¬ì ê²°ì •ì— ë„ì›€ì„ ë“œë¦½ë‹ˆë‹¤.<br>
    ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •ì„ í†µí•´ ì‹¤ì œ íˆ¬ì í™˜ê²½ê³¼ ìœ ì‚¬í•œ ì¡°ê±´ì—ì„œ ë”ìš± ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì–´ë³´ì‹œê³ , <strong>ì „ì¼ ì¢…ê°€ ì¡°íšŒ ê¸°ëŠ¥(ì¢…ëª©ì½”ë“œ/ì¢…ëª©ëª… ê²€ìƒ‰ ì§€ì›)</strong>ìœ¼ë¡œ í˜„ì¬ê°€ ì…ë ¥ì˜ í¸ì˜ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”!
</div>

<section id="settingsSection">
    <h3âš™ï¸ ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •</h3>
    <div class="input-group"> <label for="buyFeeRate">ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ (%)</label> <input type="number" id="buyFeeRate" value="0.015" step="0.001" min="0"> </div>
    <div class="input-group"> <label for="sellFeeRate">ë§¤ë„ ìˆ˜ìˆ˜ë£Œ (%)</label> <input type="number" id="sellFeeRate" value="0.015" step="0.001" min="0"> </div>
    <div class="input-group"> <label for="taxRate">ì„¸ê¸ˆ (%)</label> <input type="number" id="taxRate" value="0.2" step="0.01" min="0"> </div>
    <button id="setFeesToZeroBtn" class="secondary" style="margin-top: 10px;">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ë¯¸ì ìš© (0%ë¡œ ì„¤ì •)</button>
    <small style="display:block; color:gray; margin-top:5px;"> â€» êµ­ë‚´ ì£¼ì‹ ê¸°ì¤€ ê¸°ë³¸ê°’ (ì¦ê¶Œì‚¬ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë©°, ì„¸ê¸ˆì€ êµ­ê°€/ìƒí’ˆë³„ë¡œ ìƒì´) </small>
</section>

<section id="initialPurchaseSection">
  <h3>â‘  ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥</h3>
  <div class="input-group"> <label for="initPrice">ìµœì´ˆ ë§¤ìˆ˜ê°€ (ì›)</label> <input type="number" id="initPrice" min="0"> </div>
  <div class="input-group"> <label for="initAmount">ìµœì´ˆ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label> <input type="number" id="initAmount" min="1"> </div>
  <button id="setInitialPurchaseBtn" onclick="setInitialPurchase()">âœ” ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥</button>
  <button id="clearInitialPurchaseBtn" class="secondary" onclick="clearInitialPurchase()">ğŸ§¹ ìµœì´ˆ ë§¤ìˆ˜ ì´ˆê¸°í™”</button>
</section>

<section>
  <h3>â‘¡ ì¶”ê°€ ë§¤ìˆ˜ ì…ë ¥</h3>
  <div id="additionalInputs"></div>
  <button onclick="addBuyBlock()">â• ì¶”ê°€ ë§¤ìˆ˜ í•­ëª© ì¶”ê°€</button>
  <button class="secondary" onclick="clearAdditionalBuys()">â– ì¶”ê°€ ë§¤ìˆ˜ ì „ì²´ ì´ˆê¸°í™”</button>
</section>

<section>
  <h3>â‘¢ í‰ê·  ë‹¨ê°€ & ì†ìµ ê³„ì‚°</h3>
  <div id="summaryResult"></div>
  <div class="input-group" style="margin-top: 15px; margin-bottom: 5px;">
    <label for="stockCodeInput" style="flex-basis: auto; margin-right: 10px;">ì¢…ëª©ì½”ë“œ/ëª…:</label>
    <input type="text" id="stockCodeInput" placeholder="ì¢…ëª©ì½”ë“œ(6ìë¦¬) ë˜ëŠ” ì¢…ëª©ëª… ì…ë ¥">
  </div>
  <div class="input-group" style="margin-top: 5px; margin-bottom: 5px;">
    <label for="historicalDaysInput" style="flex-basis: auto; margin-right: 10px;">ì¡°íšŒ ê¸°ê°„(ì¼):</label>
    <input type="number" id="historicalDaysInput" value="90" min="1" max="365" style="width: 80px; flex-grow:0;"> 
    <button id="fetchPriceBtn" class="secondary" style="width: auto; padding: 10px 15px; margin-left: 5px; flex-shrink: 0;">ğŸ“ˆ ê¸°ê°„ì‹œì„¸ ì¡°íšŒ</button>
  </div>
  <div class="input-group">
    <label for="currentPriceInput">í˜„ì¬(ë˜ëŠ” ê¸°ì¤€) ì£¼ê°€ (ì›):</label>
    <input type="number" id="currentPriceInput" min="0">
  </div>
  <small style="display:block; color:gray; margin-bottom:5px;"> â€» "ê¸°ê°„ì‹œì„¸ ì¡°íšŒ" ì‹œ ìµœì‹ ì¼ ì¢…ê°€ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤. ì§ì ‘ ê¸°ì¤€ ì£¼ê°€ë¥¼ ì…ë ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. </small>
  <button onclick="calculateProfit()">ğŸ“ˆ ì†ìµ ê³„ì‚°</button>
  <button class="secondary" onclick="clearProfitCalculation()">ğŸ“‰ ì†ìµ ê³„ì‚° ì´ˆê¸°í™”</button>
  <div id="profitResultTable"></div>
  <div id="breakEven" style="margin-top: 10px;"></div>
</section>

<section>
  <h3>â‘£ ëª©í‘œ ìˆ˜ìµë¥  ê¸°ë°˜ ë§¤ë„ ê°€ê²© ê³„ì‚°</h3>
  <div class="input-group"> <label for="targetROI">ëª©í‘œ ìˆ˜ìµë¥  (%)</label> <input type="number" id="targetROI" min="0"> </div>
  <button onclick="calculateTargetSellPrice()">ğŸ¯ ë§¤ë„ ëª©í‘œê°€ ê³„ì‚°</button>
  <div id="targetPriceResult"></div>
  <div id="targetPriceTable"></div>
</section>

<section id="purchaseHistorySection">
  <h3>â‘¦ ìƒì„¸ ë§¤ìˆ˜ ë‚´ì—­</h3>
  <div id="purchaseHistoryTableContainer"></div>
</section>

<section>
 <h3>â‘§ ê¸°ê°„ë³„ ì‹œì„¸ ë° ë‚˜ì˜ í‰ê· ë‹¨ê°€ ë¹„êµ</h3>
  <div style="position: relative; height: 300px; width: 100%; max-width: 800px; margin: 20px auto;">
    <canvas id="priceComparisonChart"></canvas> </div>
</section>

<section>
  <h3>â‘¤ ë°ì´í„° ì €ì¥ ë° ì°¨íŠ¸ ì‹œê°í™”</h3>
  <button onclick="saveData()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
  <button class="secondary" onclick="loadData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ë¡œ ì €ì¥</button>
  <button class="secondary" onclick="resetAllData()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
</section>

<canvas id="avgPriceChart" width="800" height="400" style="width: 100%; max-width: 800px;"></canvas>
<canvas id="volumeChart" width="800" height="400" style="width: 100%; max-width: 800px; margin-top: 40px;"></canvas>
<section>
  <h3>â‘¥ íˆ¬ì ë¹„ì¤‘ (ë§¤ìˆ˜ ê¸ˆì•¡ ê¸°ì¤€)</h3>
  <canvas id="investmentPieChart" width="800" height="400" style="width: 100%; max-width: 600px; margin: 20px auto; display: block;"></canvas>
</section>

<div id="notificationArea" class="notification"></div>

<script>
// --- Constants ---
const LS_KEY_DATA = "investmentCalculatorData_v2_6_1"; // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ë²„ì „ì—…
const LS_KEY_DARK_MODE = "investmentCalculatorDarkMode_v2_6_1";
const DATA_GO_KR_API_KEY = 'y0pPGOvyGt483NgWSHJx4MKR9B0iUY2a3kul4wYFxbyH85zaR2hDNhY5OilDkfj%2F9M26UOZeUZJuTcZWntB6Rw%3D%3D';

// --- DOM Elements Cache ---
const dom = {};

// --- Application State ---
let appState = {
  purchases: [], avgBuyPrice: 0, totalAmount: 0, totalInvestedCost: 0,
  fees: { buyRate: 0.00015, sellRate: 0.00015, taxRate: 0.002 },
  currentPrice: 0, targetROI: 0,
  fetchedStockInfo: { code: '', name: '', price: 0, date: '' },
  historicalPrices: [] // ì¼ë³„ ì‹œì„¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
};

async function fetchHistoricalStockData(searchInput, daysToFetch) {
    showNotification('ê¸°ê°„ ì‹œì„¸ ì¡°íšŒ ì¤‘...', 'info');
    const today = new Date();
    const endDate = new Date(today);
    endDate.setDate(today.getDate() - 1); // ì–´ì œ ë‚ ì§œë¥¼ ì¢…ë£Œì¼ë¡œ

    const startDate = new Date(today);
    startDate.setDate(today.getDate() - daysToFetch); // ì¡°íšŒ ì‹œì‘ì¼

    const endBasDt = `${endDate.getFullYear()}${(endDate.getMonth() + 1).toString().padStart(2, '0')}${endDate.getDate().toString().padStart(2, '0')}`;
    const beginBasDt = `${startDate.getFullYear()}${(startDate.getMonth() + 1).toString().padStart(2, '0')}${startDate.getDate().toString().padStart(2, '0')}`;

    let searchParamKey = '';
    let searchTypeMsg = '';
    const trimmedInput = searchInput.trim();

    if (/^\d{6}$/.test(trimmedInput)) {
        searchParamKey = 'likeSrtnCd';
        searchTypeMsg = `ì½”ë“œ ${trimmedInput}`;
    } else {
        searchParamKey = 'likeItmsNm';
        searchTypeMsg = `ì¢…ëª©ëª… '${trimmedInput}'`;
    }

    // numOfRowsëŠ” ê¸°ê°„ ë‚´ ê±°ë˜ì¼ ìˆ˜ë³´ë‹¤ ë„‰ë„‰í•˜ê²Œ ì„¤ì • (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)
    // ì˜ˆ: 90ì¼ ê¸°ê°„ì´ë©´ ì‹¤ì œ ê±°ë˜ì¼ì€ ì•½ 60~65ì¼. ë„‰ë„‰íˆ 100~120 ì •ë„ë¡œ ì„¤ì •.
    const apiNumOfRows = Math.max(daysToFetch + 10, 120); // ìµœì†Œ 120ê°œ, ë˜ëŠ” daysToFetch + 10 ì¤‘ í° ê°’

    const apiUrl = `https://apis.data.go.kr/1160100/service/GetStockSecuritiesInfoService/getStockPriceInfo?serviceKey=${DATA_GO_KR_API_KEY}&numOfRows=${apiNumOfRows}&pageNo=1&resultType=json&${searchParamKey}=${encodeURIComponent(trimmedInput)}&beginBasDt=${beginBasDt}&endBasDt=${endBasDt}`;
    
    console.log(`[fetchHistoricalStockData] API URL: ${apiUrl}`);

    try {
        const response = await fetch(apiUrl);
        const responseText = await response.clone().text();
        console.log(`[fetchHistoricalStockData] API Raw Response:`, responseText.substring(0, 800));

        if (!response.ok) {
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨(${response.status}). ì‘ë‹µ: ${responseText.substring(0, 200)}`);
        }

        if (responseText.trim().startsWith('<')) {
            console.warn(`APIê°€ XML ì‘ë‹µì„ ë°˜í™˜. ë‚´ìš©: ${responseText.substring(0, 200)}...`);
            if (responseText.includes("SERVICE_KEY_IS_NOT_REGISTERED_ERROR")) {
                showNotification('API í‚¤ ì˜¤ë¥˜: ì„œë¹„ìŠ¤ í‚¤ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            } else if (responseText.includes("NODATA_ERROR")) { // NODATA_ERROR (04) ë“±
                 showNotification(`${searchTypeMsg}ì— ëŒ€í•œ ê¸°ê°„ ë‚´(${beginBasDt}~${endBasDt}) ê±°ë˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'error');
            } else {
                showNotification('APIë¡œë¶€í„° ì˜ˆìƒì¹˜ ëª»í•œ XML ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.', 'error');
            }
            appState.historicalPrices = []; // ë°ì´í„° ì—†ìŒ ì²˜ë¦¬
            appState.fetchedStockInfo = { code: trimmedInput, name: '', price: 0, date: '' };
            appState.currentPrice = 0; // í˜„ì¬ê°€ë„ ì´ˆê¸°í™”
            if(dom.currentPriceInput) dom.currentPriceInput.value = '';
            recalculateAndUpdateUI(); // ì°¨íŠ¸ ë“± UI ì—…ë°ì´íŠ¸
            return;
        }
        
        const data = JSON.parse(responseText);
        console.log(`[fetchHistoricalStockData] API Parsed Data:`, data);

        if (data.response && data.response.header && data.response.header.resultCode === '00') {
            if (data.response.body && data.response.body.totalCount > 0 && data.response.body.items && data.response.body.items.item) {
                let items = Array.isArray(data.response.body.items.item) ? data.response.body.items.item : [data.response.body.items.item];
                
                // ë‚ ì§œ(basDt) ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                items.sort((a, b) => parseInt(a.basDt) - parseInt(b.basDt));
                
                appState.historicalPrices = items.map(item => ({
                    date: item.basDt, // YYYYMMDD
                    price: parseFloat(item.clpr)
                }));

                if (appState.historicalPrices.length > 0) {
                    const latestData = appState.historicalPrices[appState.historicalPrices.length - 1];
                    const firstItem = items[0]; // ì •ë ¬ í›„ ì²«ë²ˆì§¸ ì•„ì´í…œ (ê°€ì¥ ì˜¤ë˜ëœ ë°ì´í„°) ë˜ëŠ” API ì‘ë‹µì˜ ì²«ë²ˆì§¸ ì•„ì´í…œ
                    
                    appState.currentPrice = latestData.price;
                    dom.currentPriceInput.value = latestData.price;
                    appState.fetchedStockInfo = { 
                        code: items[0].srtnCd || trimmedInput, // API ì‘ë‹µì˜ ì½”ë“œë¥¼ ìš°ì„  ì‚¬ìš©
                        name: items[0].itmsNm || (searchParamKey === 'likeItmsNm' ? trimmedInput : ''), 
                        price: latestData.price, 
                        date: latestData.date 
                    };
                     if (searchParamKey === 'likeItmsNm' && appState.fetchedStockInfo.code && dom.stockCodeInput.value.toUpperCase() !== appState.fetchedStockInfo.code.toUpperCase()) {
                        dom.stockCodeInput.value = appState.fetchedStockInfo.code;
                    }
                    showNotification(`${appState.fetchedStockInfo.name}(${appState.fetchedStockInfo.code}) ${daysToFetch}ì¼ê°„ ì‹œì„¸ ë¡œë“œ ì™„ë£Œ. ìµœì‹  ì¢…ê°€: ${latestData.price.toLocaleString()}ì› (${latestData.date} ê¸°ì¤€)`, 'success');
                } else { // totalCount > 0 ì¸ë° íŒŒì‹± í›„ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° (ì´ë¡ ìƒ ë“œë¬¾)
                    showNotification(`${searchTypeMsg} ê¸°ê°„ ë‚´ ì‹œì„¸ ì •ë³´ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                    appState.historicalPrices = [];
                }
            } else { // resultCode '00'ì´ì§€ë§Œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                showNotification(`${searchTypeMsg}ì— ëŒ€í•œ ê¸°ê°„ ë‚´(${beginBasDt}~${endBasDt}) ê±°ë˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (totalCount 0 ë˜ëŠ” items ì—†ìŒ)`, 'error');
                appState.historicalPrices = [];
            }
        } else if (data.response && data.response.header) { // API ì •ì˜ ì˜¤ë¥˜ (resultCode '00' ì•„ë‹˜)
            const errCode = data.response.header.resultCode;
            const errMsg = data.response.header.resultMsg;
             // ì¹˜ëª…ì  ì˜¤ë¥˜ ì™¸ì—ëŠ” ë°ì´í„° ì—†ìŒìœ¼ë¡œ ê°„ì£¼
            if (['03', '12', '20', '22', '30', '31', '32'].includes(errCode)) {
                 showNotification(`API ì˜¤ë¥˜ (${errCode}): ${errMsg}. (ì¡°íšŒ ì¤‘ë‹¨)`, 'error');
            } else {
                 showNotification(`${searchTypeMsg} ì •ë³´ ì¡°íšŒ ì¤‘ API ì‘ë‹µ (${errCode}): ${errMsg}. ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'error');
            }
            appState.historicalPrices = [];
        } else {
            throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ API ì‘ë‹µ êµ¬ì¡°ì…ë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error(`[fetchHistoricalStockData] ìµœì¢… ì˜¤ë¥˜:`, error);
        showNotification(`ê¸°ê°„ ì‹œì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ${error.message}. (ì½˜ì†” í™•ì¸)`, 'error');
        appState.historicalPrices = [];
    }
    // ë°ì´í„°ê°€ ìˆë“  ì—†ë“  UI ì—…ë°ì´íŠ¸ (ì°¨íŠ¸ í´ë¦¬ì–´ ë“±)
    if (appState.historicalPrices.length === 0) { // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ í˜„ì¬ê°€ ì •ë³´ë„ ì´ˆê¸°í™”
        appState.fetchedStockInfo = { code: trimmedInput, name: '', price: 0, date: '' };
        appState.currentPrice = 0;
        if(dom.currentPriceInput) dom.currentPriceInput.value = '';
    }
    recalculateAndUpdateUI();
}

// --- Chart Instances ---
let avgPriceChartInstance = null;
let volumeChartInstance = null;
let investmentPieChartInstance = null;
//let priceComparisonChartInstance = null;
let historicalPriceChartInstance = null;

function initializeCharts() {
    const getChartTextColors = () => ({ 
        titleColor: isDarkChartElement() ? '#e0e0e0' : '#333', 
        legendColor: isDarkChartElement() ? '#e0e0e0' : '#333', 
        tickColor: isDarkChartElement() ? '#e0e0e0' : '#666', 
        gridColor: isDarkChartElement() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' 
    });

    const commonChartOptions = (type) => {
        // ... (ì´ì „ commonChartOptions ë¡œì§ì€ ëŒ€ë¶€ë¶„ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥, íˆ´íŒ ì½œë°±ì€ ì•„ë˜ì„œ ì•½ê°„ ìˆ˜ì •)
        const colors = getChartTextColors();
        let options = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: colors.legendColor } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let datasetLabel = context.dataset.label || '';
                            let currentLabel = context.label || ''; // Xì¶• ë ˆì´ë¸” (ë‚ ì§œ ë“±)
                            let valueToShow = context.parsed.y;

                            let prefix = datasetLabel ? datasetLabel + ': ' : (currentLabel ? currentLabel + ': ' : '');

                            if (type === 'pie' || type === 'doughnut') {
                                valueToShow = context.raw;
                                const total = context.chart.getDatasetMeta(0).total;
                                const percentage = total > 0 ? ((valueToShow / total) * 100).toFixed(2) : 0;
                                return `${context.label}: ${valueToShow.toLocaleString('ko-KR')} ì› (${percentage}%)`; // íŒŒì´ì°¨íŠ¸ëŠ” context.label ì‚¬ìš©
                            } else if (datasetLabel === 'ë§¤ìˆ˜ ìˆ˜ëŸ‰') { // volumeChart
                                if (valueToShow !== null) return `${prefix}${valueToShow.toLocaleString()} ì£¼`;
                            } else { // line chart (historical, avgPrice)
                                if (valueToShow !== null) return `${prefix}${valueToShow.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›`;
                            }
                            return prefix + 'N/A';
                        }
                    }
                }
                // ì£¼ì„(annotation) ì„¤ì •ì€ ê°œë³„ ì°¨íŠ¸ì—ì„œ ì¶”ê°€
            }
        };
        // ìŠ¤ì¼€ì¼ ì„¤ì • (X, Yì¶•)
        if (type === 'line' || type === 'bar' || type === 'historicalLine') {
             options.scales = {
                y: { 
                    // beginAtZero: (type === 'bar'), // ë¼ì¸ ì°¨íŠ¸ëŠ” 0ë¶€í„° ì‹œì‘ ì•ˆ í•´ë„ ë¨
                    ticks: { 
                        callback: function(value) { return type === 'bar' ? value.toLocaleString() + ' ì£¼' : value.toLocaleString('ko-KR') + ' ì›'; }, 
                        color: colors.tickColor 
                    }, 
                    grid: { color: colors.gridColor }, 
                    title: {display: type === 'bar', text: type === 'bar' ? 'ìˆ˜ëŸ‰(ì£¼)' : '', color: colors.titleColor} 
                },
                x: { 
                    ticks: { 
                        font: { size: 10 }, 
                        color: colors.tickColor,
                        // ë‚ ì§œ í¬ë§·íŒ… ë˜ëŠ” ê±´ë„ˆë›°ê¸° (ë°ì´í„°ê°€ ë§ì„ ê²½ìš°)
                        // autoSkip: true,
                        // maxTicksLimit: 10 // ì˜ˆì‹œ: ìµœëŒ€ 10ê°œ ëˆˆê¸ˆ
                    }, 
                    grid: { color: colors.gridColor } 
                }
            };
            if (type === 'historicalLine') { // ì—­ì‚¬ì  ì‹œì„¸ ë¼ì¸ ì°¨íŠ¸ì˜ Xì¶•ì€ ë‚ ì§œ(ì¹´í…Œê³ ë¦¬ ë˜ëŠ” ì‹œê°„)
                options.scales.x.type = 'category'; // 'time'ìœ¼ë¡œ í•˜ë ¤ë©´ x ë°ì´í„°ê°€ Date ê°ì²´ì—¬ì•¼ í•¨. ì—¬ê¸°ì„  ë¬¸ìì—´ë¡œ ê°€ì •.
                // options.scales.x.time = { unit: 'day', tooltipFormat: 'yyyy-MM-dd', displayFormats: {day: 'yy/MM/dd'}};
            }
        }
        return options;
    };

    // ... (avgPriceChartInstance, volumeChartInstance, investmentPieChartInstance ì´ˆê¸°í™”ëŠ” ì´ì „ê³¼ ë™ì¼) ...
    if (dom.avgPriceChartCanvas) { /* ... */ }
    if (dom.volumeChartCanvas) { /* ... */ }
    if (dom.investmentPieChartCanvas) { /* ... */ }


    // ê¸°ê°„ë³„ ì‹œì„¸ ë° ë‚˜ì˜ í‰ê· ë‹¨ê°€ ì°¨íŠ¸ (ê¸°ì¡´ priceComparisonChart ëŒ€ì²´)
    if (dom.priceComparisonChartCanvas) { // dom ìš”ì†Œ IDëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const colors = getChartTextColors();
        historicalPriceChartInstance = new Chart(dom.priceComparisonChartCanvas.getContext('2d'), { // ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ëª…
            type: 'line',
            data: {
                labels: [], // ë‚ ì§œ
                datasets: [
                    {
                        label: 'ì¼ë³„ ì¢…ê°€',
                        data: [], // ê°€ê²©
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: false
                    }
                    // í‰ë‹¨ì„ ì€ ì£¼ì„ìœ¼ë¡œ ì²˜ë¦¬
                ]
            },
            options: {
                ...commonChartOptions('historicalLine'), // ìƒˆë¡œìš´ íƒ€ì… ë˜ëŠ” ê¸°ì¡´ line íƒ€ì… ì˜µì…˜ í™œìš©
                plugins: {
                    ...commonChartOptions('historicalLine').plugins, // ê¸°ì¡´ íˆ´íŒ, ë²”ë¡€ ì„¤ì • ìœ ì§€
                    title: {
                        display: true,
                        text: 'ğŸ“ˆ ê¸°ê°„ë³„ ì¢…ê°€ ë° ë‚˜ì˜ í‰ê· ë‹¨ê°€',
                        color: colors.titleColor
                    },
                    legend: { // ë²”ë¡€ì— í‰ë‹¨ì„  ì •ë³´ëŠ” ì—†ìœ¼ë¯€ë¡œ, ì¢…ê°€ ë¼ì¸ë§Œ í‘œì‹œë¨
                        display: true, 
                        position: 'top'
                    },
                    annotation: { // ì£¼ì„ í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
                        annotations: {
                            avgBuyPriceLine: {
                                type: 'line',
                                display: false, // ì´ˆê¸°ì— ìˆ¨ê¹€, ë°ì´í„° ìˆì„ ë•Œ í‘œì‹œ
                                yMin: 0,        // ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                yMax: 0,        // ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                borderColor: 'orange',
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    enabled: true,
                                    content: 'ë‚˜ì˜ í‰ë‹¨ê°€: 0ì›', // ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                    position: 'end',
                                    backgroundColor: 'rgba(255,159,64,0.7)', // ì£¼í™©ìƒ‰ ê³„ì—´
                                    color: 'white',
                                    font: { size: 10 },
                                    padding: 3,
                                    yAdjust: -10 // ë¼ë²¨ ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •
                                }
                            }
                        }
                    }
                }
            }
        });
        if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'none'; // ì´ˆê¸°ì— ìˆ¨ê¹€
    }
    updateDarkModeUI(isDarkChartElement());
}

// --- Helper Functions ---
function isDarkChartElement() { return document.body.classList.contains('dark'); }

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => { 

// DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ ì‹œë„
      if (typeof ChartJsPluginAnnotation !== 'undefined') {
        Chart.register(ChartJsPluginAnnotation);
        console.log('ChartJsPluginAnnotation registered successfully.');
      } else {
        console.error('ChartJsPluginAnnotation is not loaded yet!');
        showNotification('ì°¨íŠ¸ í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.', 'error');
        // ì—¬ê¸°ì„œ í”ŒëŸ¬ê·¸ì¸ ì—†ì´ ì°¨íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ê±°ë‚˜, ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ë˜ëŠ”, í”ŒëŸ¬ê·¸ì¸ì´ í•„ìˆ˜ë¼ë©´ ì°¨íŠ¸ ì´ˆê¸°í™”ë¥¼ ë§‰ì•„ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
      }
    
cacheDOMElements();
    Chart.register(ChartJsPluginAnnotation); // DOMContentLoaded ê°€ì¥ ì²˜ìŒì— ë“±ë¡

    if (dom.fetchPriceBtn) {
        dom.fetchPriceBtn.addEventListener('click', async () => {
            const searchInput = dom.stockCodeInput.value.trim();
            const daysValue = parseInt(dom.historicalDaysInput.value); // ê¸°ê°„ ê°’ ì½ê¸°

            if (!searchInput) {
                showNotification('ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (isNaN(daysValue) || daysValue < 1 || daysValue > 365) { // ìµœëŒ€ 365ì¼ë¡œ ì œí•œ (ì¡°ì • ê°€ëŠ¥)
                showNotification('ì¡°íšŒ ê¸°ê°„ì€ 1ì¼ì—ì„œ 365ì¼ ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            // í•¨ìˆ˜ëª… ë³€ê²½ ë° daysValue ì „ë‹¬
            await fetchHistoricalStockData(searchInput, daysValue); 
        });
    }
    // ... (ë‚˜ë¨¸ì§€ ì´ˆê¸°í™”) ...
});

function cacheDOMElements() {
  dom.buyFeeRateInput = document.getElementById('buyFeeRate');
  dom.sellFeeRateInput = document.getElementById('sellFeeRate');
  dom.taxRateInput = document.getElementById('taxRate');
  dom.setFeesToZeroBtn = document.getElementById('setFeesToZeroBtn');
  dom.initPriceInput = document.getElementById('initPrice');
  dom.initAmountInput = document.getElementById('initAmount');
  dom.setInitialPurchaseBtn = document.getElementById('setInitialPurchaseBtn');
  dom.clearInitialPurchaseBtn = document.getElementById('clearInitialPurchaseBtn');
  dom.initialPurchaseSection = document.getElementById('initialPurchaseSection');
  dom.additionalInputsContainer = document.getElementById('additionalInputs');
  dom.summaryResultDiv = document.getElementById('summaryResult');
  dom.stockCodeInput = document.getElementById('stockCodeInput');
  dom.fetchPriceBtn = document.getElementById('fetchPriceBtn');
  dom.currentPriceInput = document.getElementById('currentPriceInput');
  dom.profitResultTableDiv = document.getElementById('profitResultTable');
  dom.breakEvenDiv = document.getElementById('breakEven');
  dom.targetROIInput = document.getElementById('targetROI');
  dom.targetPriceResultDiv = document.getElementById('targetPriceResult');
  dom.targetPriceTableDiv = document.getElementById('targetPriceTable');
  dom.notificationArea = document.getElementById('notificationArea');
  dom.darkModeBtn = document.getElementById('darkModeBtn');
  dom.avgPriceChartCanvas = document.getElementById('avgPriceChart');
  dom.volumeChartCanvas = document.getElementById('volumeChart');
  dom.investmentPieChartCanvas = document.getElementById('investmentPieChart');
  dom.purchaseHistoryTableContainer = document.getElementById('purchaseHistoryTableContainer');
  dom.priceComparisonChartCanvas = document.getElementById('priceComparisonChart');
}

async function fetchPreviousDayClosePrice(searchInput, attempts = 0) {
    const MAX_ATTEMPTS = 7; // ìµœëŒ€ 7ì¼ ì „ê¹Œì§€ ì¡°íšŒ ì‹œë„

    if (attempts >= MAX_ATTEMPTS) {
        const initialSearchTerm = searchInput.match(/^\d{6}$/) ? searchInput : `'${searchInput}'`;
        showNotification(`${initialSearchTerm}ì— ëŒ€í•œ ìµœê·¼ ${MAX_ATTEMPTS}ì¼ê°„ ê±°ë˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
        appState.fetchedStockInfo = { code: searchInput.match(/^\d{6}$/) ? searchInput : '', name: '', price: 0, date: '' };
        recalculateAndUpdateUI();
        return;
    }

    const dateToQuery = new Date();
    // ì²« ì‹œë„ë©´ ì–´ì œ, ì´í›„ ì‹œë„ë©´ í•˜ë£¨ì”© ë” ê³¼ê±°ë¡œ
    dateToQuery.setDate(dateToQuery.getDate() - 1 - attempts); 

    const year = dateToQuery.getFullYear();
    const month = (dateToQuery.getMonth() + 1).toString().padStart(2, '0');
    const day = dateToQuery.getDate().toString().padStart(2, '0');
    const basDt = `${year}${month}${day}`;

    // â˜…â˜…â˜… ì—¬ê¸°ì— console.log ì¶”ê°€í•˜ì—¬ í™•ì¸ â˜…â˜…â˜…
    console.log(`[fetchPreviousDayClosePrice] ìƒì„±ëœ basDt (ê¸°ì¤€ì¼ì): ${basDt}`); 
    console.log(`[fetchPreviousDayClosePrice] í˜„ì¬ ì‹œë„ íšŸìˆ˜ (attempts): ${attempts}`);
    console.log(`[fetchPreviousDayClosePrice] ì¡°íšŒ ëŒ€ìƒ ë‚ ì§œ (dateToQuery): ${dateToQuery.toLocaleDateString('ko-KR')}`);

    let searchParamKey = '';
    let searchTypeMsg = '';
    const trimmedInput = searchInput.trim();

    if (/^\d{6}$/.test(trimmedInput)) {
        searchParamKey = 'likeSrtnCd';
        searchTypeMsg = `ì½”ë“œ ${trimmedInput}`;
    } else {
        searchParamKey = 'likeItmsNm';
        searchTypeMsg = `ì¢…ëª©ëª… '${trimmedInput}'`;
    }

    const apiUrl = `https://apis.data.go.kr/1160100/service/GetStockSecuritiesInfoService/getStockPriceInfo?serviceKey=${DATA_GO_KR_API_KEY}&numOfRows=1&pageNo=1&resultType=json&${searchParamKey}=${encodeURIComponent(trimmedInput)}&basDt=${basDt}`;

    if (attempts === 0) {
        showNotification(`${searchTypeMsg} ì „ì¼ ì¢…ê°€ ì¡°íšŒ ì¤‘... (ê¸°ì¤€ì¼: ${basDt})`, 'info');
    } else {
        // ì¬ì‹œë„ ì•Œë¦¼ì€ ì§§ê²Œ í‘œì‹œí•˜ê±°ë‚˜ ì½˜ì†”ì—ë§Œ ë¡œê¹…
        showNotification(`${searchTypeMsg} ì´ì „ ë‚ ì§œ ì¡°íšŒ ì¤‘... (${attempts + 1}ë²ˆì§¸ ì‹œë„, ê¸°ì¤€ì¼: ${basDt})`, 'info', 1500);
        console.log(`ì¬ì‹œë„ (${attempts + 1}/${MAX_ATTEMPTS}): ${searchTypeMsg}, ê¸°ì¤€ì¼: ${basDt}`);
    }

    try {
        const response = await fetch(apiUrl);
        const responseText = await response.clone().text(); // ì›ì‹œ í…ìŠ¤íŠ¸ í™•ì¸ìš©
        console.log(`API Raw Response (ì‹œë„ ${attempts + 1}, ê¸°ì¤€ì¼ ${basDt}):`, responseText.substring(0, 500)); // ë„ˆë¬´ ê¸¸ë©´ ì¼ë¶€ë§Œ

        if (!response.ok) { // HTTP ì˜¤ë¥˜ (4xx, 5xx)
             // íŠ¹ì • HTTP ì˜¤ë¥˜ ì½”ë“œì— ë”°ë¼ ì¬ì‹œë„ ì—¬ë¶€ ê²°ì • ê°€ëŠ¥í•˜ë‚˜, ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì¤‘ë‹¨
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨(${response.status}). ì‘ë‹µ: ${responseText.substring(0,200)}`);
        }

        // APIê°€ XML ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¨¼ì € í™•ì¸
        if (responseText.trim().startsWith('<')) {
            console.warn(`APIê°€ XML ì‘ë‹µì„ ë°˜í™˜ (ì‹œë„ì¼: ${basDt}). ë‚´ìš©: ${responseText.substring(0,200)}...`);
            if (responseText.includes("SERVICE_KEY_IS_NOT_REGISTERED_ERROR")) {
                 showNotification('API í‚¤ ì˜¤ë¥˜: ì„œë¹„ìŠ¤ í‚¤ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                 return; // ì¹˜ëª…ì  ì˜¤ë¥˜, ì¬ì‹œë„ ì¤‘ë‹¨
            }
            // ë‹¤ë¥¸ XML ì˜¤ë¥˜ëŠ” "ë°ì´í„° ì—†ìŒ"ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì¬ì‹œë„
            await fetchPreviousDayClosePrice(searchInput, attempts + 1);
            return;
        }
        
        const data = JSON.parse(responseText); // JSON íŒŒì‹± ì‹œë„
        console.log(`API Parsed Data (ì‹œë„ ${attempts + 1}, ê¸°ì¤€ì¼ ${basDt}):`, data);

        let closePrice = null;
        let itemName = trimmedInput;
        let itemCode = (searchParamKey === 'likeSrtnCd') ? trimmedInput : '';
        let dataDate = basDt;

if (data.response && data.response.header && data.response.header.resultCode === '00') {
    // ì •ìƒ ì‘ë‹µ (resultCode '00')
    if (data.response.body && data.response.body.totalCount > 0 && data.response.body.items && data.response.body.items.item) {
        // ë°ì´í„°ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•¨ (totalCount > 0 ì´ê³  items.itemì´ ì¡´ì¬)
        const itemData = Array.isArray(data.response.body.items.item) ? data.response.body.items.item[0] : data.response.body.items.item;

        if (itemData && typeof itemData.clpr !== 'undefined' && String(itemData.clpr).trim() !== '') { // clpr í•„ë“œê°€ ìˆê³ , ë¬¸ìì—´ë¡œ ë³€í™˜í•´ë„ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            closePrice = itemData.clpr;
            itemName = itemData.itmsNm || itemName;
            itemCode = itemData.srtnCd || itemCode; // API ì‘ë‹µì˜ srtnCdë¥¼ ìš°ì„  ì‚¬ìš©
            dataDate = itemData.basDt || dataDate;   // API ì‘ë‹µì˜ basDtë¥¼ ìš°ì„  ì‚¬ìš©

            // --- ì´ ì•„ë˜ëŠ” ì„±ê³µì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì°¾ì•˜ì„ ë•Œì˜ ë¡œì§ ---
            const price = parseFloat(closePrice);
            if (!isNaN(price)) { // closePriceê°€ ìœ íš¨í•œ ìˆ«ìì¸ì§€ ìµœì¢… í™•ì¸
                dom.currentPriceInput.value = price;
                appState.currentPrice = price;
                appState.fetchedStockInfo = { code: itemCode, name: itemName, price: price, date: dataDate };

                // ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•´ì„œ ì‹¤ì œ ì½”ë“œë¥¼ ì°¾ì•˜ë‹¤ë©´ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                if (searchParamKey === 'likeItmsNm' && itemCode && dom.stockCodeInput.value.toUpperCase() !== itemCode.toUpperCase()) {
                    dom.stockCodeInput.value = itemCode;
                }
                showNotification(`${itemName}(${itemCode || trimmedInput}) ì¢…ê°€(${price.toLocaleString()}ì›, ${dataDate} ê¸°ì¤€) ë¡œë“œ ì™„ë£Œ.`, 'success');
                recalculateAndUpdateUI();
                return; // â˜…â˜…â˜… ì¤‘ìš”: ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì¬ê·€í˜¸ì¶œ ì—†ì´ í•¨ìˆ˜ ì¢…ë£Œ
            } else {
                // clpr ê°’ì´ ìˆì—ˆì§€ë§Œ ìˆ«ìë¡œ ë³€í™˜ ì‹¤íŒ¨ (ì˜ˆìƒì¹˜ ëª»í•œ ê°’)
                console.log(`ì¢…ê°€(clpr) ê°’ [${itemData.clpr}]ì„ ìˆ«ìë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŒ: ${searchTypeMsg}, ê¸°ì¤€ì¼: ${basDt}. ì´ì „ ë‚ ì§œë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.`);
                await fetchPreviousDayClosePrice(searchInput, attempts + 1);
                return;
            }
        } else {
            // itemDataëŠ” ìˆì§€ë§Œ clpr í•„ë“œê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° -> ë°ì´í„° ì—†ìŒìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì¬ì‹œë„
            console.log(`ìœ íš¨í•œ ì¢…ê°€(clpr) ì—†ìŒ (itemDataëŠ” ì¡´ì¬): ${searchTypeMsg}, ê¸°ì¤€ì¼: ${basDt}. ì´ì „ ë‚ ì§œë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.`);
            await fetchPreviousDayClosePrice(searchInput, attempts + 1);
            return;
        }
    } else {
        // resultCode '00' ì´ì§€ë§Œ, totalCountê°€ 0ì´ê±°ë‚˜ items.itemì´ ì—†ëŠ” ê²½ìš° -> ë°ì´í„° ì—†ìŒìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì¬ì‹œë„
        console.log(`ë°ì´í„° ì—†ìŒ (totalCount 0 ë˜ëŠ” items ì—†ìŒ): ${searchTypeMsg}, ê¸°ì¤€ì¼: ${basDt}. ì´ì „ ë‚ ì§œë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.`);
        await fetchPreviousDayClosePrice(searchInput, attempts + 1);
        return;
    }
} else if (data.response && data.response.header) { // APIê°€ ì •ì˜í•œ ì˜¤ë¥˜ ì½”ë“œ ë°˜í™˜ (resultCodeê°€ '00'ì´ ì•„ë‹˜)
    const errCode = data.response.header.resultCode;
    const errMsg = data.response.header.resultMsg;
    // ì¹˜ëª…ì ì¸ API ì˜¤ë¥˜(í‚¤ ë¬¸ì œ ë“±)ëŠ” ì¬ì‹œë„ ì¤‘ë‹¨
    if (['03', '12', '20', '22', '30', '31', '32'].includes(errCode)) { // ë¬¸ì„œ ì°¸ê³ 
        showNotification(`API ì˜¤ë¥˜ (${errCode}): ${errMsg}. (ì¡°íšŒ ì¤‘ë‹¨)`, 'error');
        appState.fetchedStockInfo = { code: trimmedInput, name: '', price: 0, date: '' };
        recalculateAndUpdateUI();
        return; 
    }
    // ê·¸ ì™¸ ì˜¤ë¥˜ëŠ” "ë°ì´í„° ì—†ìŒ"ê³¼ ìœ ì‚¬í•˜ê²Œ ì´ì „ ë‚ ì§œë¡œ ì¬ì‹œë„ (APIê°€ ê°„í—ì ìœ¼ë¡œ ë‹¤ë¥¸ ì˜¤ë¥˜ ì½”ë“œë¥¼ ì¤„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ)
    console.warn(`API ì˜¤ë¥˜ (${errCode}): ${errMsg}. ì´ì „ ë‚ ì§œë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.`);
    await fetchPreviousDayClosePrice(searchInput, attempts + 1);
    return;
} else {
    // API ì‘ë‹µì´ ì˜ˆìƒëœ response.header êµ¬ì¡°ê°€ ì•„ë‹Œ ê²½ìš°
    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ API ì‘ë‹µ êµ¬ì¡°ì…ë‹ˆë‹¤. (response.header ëˆ„ë½)');
}
        if (closePrice !== null && !isNaN(parseFloat(closePrice))) {
            const price = parseFloat(closePrice);
            dom.currentPriceInput.value = price;
            appState.currentPrice = price;
            appState.fetchedStockInfo = { code: itemCode, name: itemName, price: price, date: dataDate };
            if (searchParamKey === 'likeItmsNm' && itemCode && dom.stockCodeInput.value.toUpperCase() !== itemCode.toUpperCase()) {
                 dom.stockCodeInput.value = itemCode;
            }
            showNotification(`${itemName}(${itemCode}) ì¢…ê°€(${price.toLocaleString()}ì›, ${dataDate} ê¸°ì¤€) ë¡œë“œ ì™„ë£Œ.`, 'success');
            recalculateAndUpdateUI();
        } else {
            // ì´ ê²½ìš°ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì¬ì‹œë„ ë¡œì§ìœ¼ë¡œ ë¹ ì¡Œì–´ì•¼ í•¨.
            // ë§Œì•½ ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ë©´ ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©.
            showNotification(`ìµœì¢…ì ìœ¼ë¡œ '${trimmedInput}' ì¢…ê°€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`, 'error');
            appState.fetchedStockInfo = { code: trimmedInput, name: '', price: 0, date: '' };
            recalculateAndUpdateUI();
        }
    } catch (error) {
        console.error(`ìµœì¢… ì˜¤ë¥˜ (ì‹œë„ ${attempts + 1}, ê¸°ì¤€ì¼: ${basDt}):`, error);
        // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í•˜ê¸° ì „ì˜ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ì€ ì¬ì‹œë„ ë¡œì§ìœ¼ë¡œ ë„˜ì–´ê°
        if (attempts + 1 >= MAX_ATTEMPTS) {
             showNotification(`ì „ì¼ ì¢…ê°€ ì¡°íšŒ ì¤‘ ìµœì¢… ì˜¤ë¥˜: ${error.message}. (ì½˜ì†” í™•ì¸)`, 'error');
             appState.fetchedStockInfo = { code: trimmedInput, name: '', price: 0, date: '' };
             recalculateAndUpdateUI();
        } else {
             // ì¼ë°˜ì ì¸ fetch ì˜¤ë¥˜(ë„¤íŠ¸ì›Œí¬ ë“±) ë°œìƒ ì‹œ ë‹¤ìŒ ë‚ ì§œë¡œ ì¬ì‹œë„
             await fetchPreviousDayClosePrice(searchInput, attempts + 1);
        }
    }
}

function showNotification(message, type = 'info', duration = 3000) { // duration íŒŒë¼ë¯¸í„° ì¶”ê°€
  dom.notificationArea.textContent = message;
  dom.notificationArea.className = `notification ${type} show`;
  setTimeout(() => { dom.notificationArea.classList.remove('show'); }, duration);
}

function initializeFeeEventListeners() {
    ['buyFeeRateInput', 'sellFeeRateInput', 'taxRateInput'].forEach(key => {
        const inputElement = dom[key];
        if (inputElement) {
            inputElement.addEventListener('change', () => {
                appState.fees.buyRate = parseFloat(dom.buyFeeRateInput.value) / 100 || 0;
                appState.fees.sellRate = parseFloat(dom.sellFeeRateInput.value) / 100 || 0;
                appState.fees.taxRate = parseFloat(dom.taxRateInput.value) / 100 || 0;
                recalculateAndUpdateUI();
                showNotification('ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            });
        }
    });
}
function loadSettings() {
    appState.fees.buyRate = parseFloat(dom.buyFeeRateInput.value) / 100 || 0;
    appState.fees.sellRate = parseFloat(dom.sellFeeRateInput.value) / 100 || 0;
    appState.fees.taxRate = parseFloat(dom.taxRateInput.value) / 100 || 0;
}
function setFeesToZeroAndRecalculate() {
  dom.buyFeeRateInput.value = '0';
  dom.sellFeeRateInput.value = '0';
  dom.taxRateInput.value = '0';
  appState.fees.buyRate = 0;
  appState.fees.sellRate = 0;
  appState.fees.taxRate = 0;
  recalculateAndUpdateUI();
  showNotification('ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆì´ 0%ë¡œ ì„¤ì •ë˜ì–´ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}
function recalculateAndUpdateUI() {
    updateAggregates();
    renderSummary();
    renderPurchaseHistoryTable();
    if (appState.purchases.length > 0) {
        if (dom.currentPriceInput.value || appState.currentPrice > 0) { calculateProfit(); }
        else { clearProfitCalculation(); }
        if (dom.targetROIInput.value || appState.targetROI !== 0) { calculateTargetSellPrice(); }
        else { clearTargetPriceCalculation(); }
    } else {
        clearProfitCalculation();
        clearTargetPriceCalculation();
    }
    updateCharts();
}
function showNotification(message, type = 'info') {
  dom.notificationArea.textContent = message;
  dom.notificationArea.className = `notification ${type} show`;
  setTimeout(() => { dom.notificationArea.classList.remove('show'); }, 3000);
}
function renderSummary() {
  if (appState.purchases.length === 0) {
    dom.summaryResultDiv.innerHTML = 'ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.'; return;
  }
  dom.summaryResultDiv.innerHTML = `
    ì´ ë³´ìœ  ìˆ˜ëŸ‰: ${appState.totalAmount.toLocaleString()} ì£¼<br>
    í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£Œ í¬í•¨): ${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ì›<br>
    ì´ íˆ¬ì ì›ê¸ˆ (ìˆ˜ìˆ˜ë£Œ í¬í•¨): ${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ì›`;
}
function renderPurchaseHistoryTable() {
    if (!dom.purchaseHistoryTableContainer) return;
    if (appState.purchases.length === 0) {
        dom.purchaseHistoryTableContainer.innerHTML = '<p style="text-align:center; color:grey;">ìƒì„¸ ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return;
    }
    let tableHTML = `<table class="purchase-history-table"><thead><tr>
                    <th>íšŒì°¨</th><th>ë§¤ìˆ˜ê°€(ì›)</th><th>ìˆ˜ëŸ‰(ì£¼)</th>
                    <th>ë§¤ìˆ˜ê¸ˆì•¡(ì›)<br><small>(ìˆ˜ìˆ˜ë£Œ ë¯¸í¬í•¨)</small></th><th>ìˆ˜ìˆ˜ë£Œ(ì›)</th>
                    <th>ì´ë§¤ìˆ˜ê¸ˆì•¡(ì›)<br><small>(ìˆ˜ìˆ˜ë£Œ í¬í•¨)</small></th><th>ë§¤ìˆ˜í›„<br>ëˆ„ì í‰ë‹¨ê°€(ì›)</th>
                    <th>ë§¤ìˆ˜í›„<br>ëˆ„ì ìˆ˜ëŸ‰(ì£¼)</th><th>ë§¤ìˆ˜í›„<br>ëˆ„ì ì´ì›ê¸ˆ(ì›)</th>
                </tr></thead><tbody>`;
    let cumulativeAmount = 0; let cumulativeInvestedCost = 0;
    appState.purchases.forEach((p, index) => {
        const purchaseName = index === 0 ? `ìµœì´ˆ` : `ì¶”ê°€ ${index}`;
        const purchaseCostNoFee = p.price * p.amount;
        const buyFeeAmount = purchaseCostNoFee * appState.fees.buyRate;
        const tempCumulativeAmount = cumulativeAmount + p.amount;
        const tempCumulativeInvestedCost = cumulativeInvestedCost + p.costWithFee;
        const currentPurchaseCumulativeAvgPrice = tempCumulativeAmount > 0 ? tempCumulativeInvestedCost / tempCumulativeAmount : 0;
        tableHTML += `<tr>
                <td>${purchaseName}</td><td>${p.price.toLocaleString()}</td><td>${p.amount.toLocaleString()}</td>
                <td>${purchaseCostNoFee.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                <td>${buyFeeAmount.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${p.costWithFee.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${currentPurchaseCumulativeAvgPrice.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${tempCumulativeAmount.toLocaleString()}</td>
                <td>${tempCumulativeInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>`;
        cumulativeAmount = tempCumulativeAmount; cumulativeInvestedCost = tempCumulativeInvestedCost;
    });
    tableHTML += `</tbody></table>`;
    dom.purchaseHistoryTableContainer.innerHTML = tableHTML;
}
function toggleInitialPurchaseInputs(disabled) {
    dom.initPriceInput.disabled = disabled; dom.initAmountInput.disabled = disabled;
    dom.setInitialPurchaseBtn.disabled = disabled; dom.initialPurchaseSection.style.opacity = disabled ? '0.7' : '1';
}
function setInitialPurchase() {
  const price = parseFloat(dom.initPriceInput.value); const amount = parseInt(dom.initAmountInput.value);
  if (isNaN(price) || price <= 0 || isNaN(amount) || amount <= 0) { showNotification('ìµœì´ˆ ë§¤ìˆ˜ê°€ì™€ ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ í° ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error'); return; }
  appState.purchases = [{ price, amount, id: `initial-${Date.now()}` }];
  recalculateAndUpdateUI(); toggleInitialPurchaseInputs(true);
  showNotification(`ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥ ì™„ë£Œ: ${price.toLocaleString()}ì›, ${amount.toLocaleString()}ì£¼`, 'success');
}
function clearInitialPurchase() {
  dom.initPriceInput.value = ''; dom.initAmountInput.value = '';
  if (appState.purchases.length === 1 && dom.additionalInputsContainer.children.length === 0 && appState.purchases[0].id.startsWith('initial-')) { appState.purchases = []; }
  else if (appState.purchases.length > 0 && dom.additionalInputsContainer.children.length > 0) { showNotification('ìµœì´ˆ ë§¤ìˆ˜ë¥¼ ìˆ˜ì •/ì‚­ì œí•˜ë ¤ë©´ "ì „ì²´ ì´ˆê¸°í™”"ë¥¼ ì´ìš©í•˜ê±°ë‚˜, ì¶”ê°€ ë§¤ìˆ˜ë¥¼ ë¨¼ì € ëª¨ë‘ ì œê±°í•´ì£¼ì„¸ìš”.', 'info'); return; }
  else { appState.purchases = []; }
  recalculateAndUpdateUI(); toggleInitialPurchaseInputs(false);
  showNotification('ìµœì´ˆ ë§¤ìˆ˜ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}
function addBuyBlock() {
  if (appState.purchases.length === 0) { showNotification('ìµœì´ˆ ë§¤ìˆ˜ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
  const block = document.createElement('div'); block.className = 'buy-block';
  const blockId = `buyBlock-${Date.now()}`;
  block.innerHTML = `<div class="input-group"><label for="addPrice-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ê°€ (ì›)</label><input type="number" id="addPrice-${blockId}" min="0"></div><div class="input-group"><label for="addAmount-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label><input type="number" id="addAmount-${blockId}" min="1"></div><button onclick="applyBuy(this, '${blockId}')">âœ” ì´ ë§¤ìˆ˜ ë°˜ì˜</button><button class="secondary" onclick="removeBuyBlock(this, '${blockId}')">âŒ ì´ ë§¤ìˆ˜ ì‚­ì œ</button>`;
  dom.additionalInputsContainer.appendChild(block); block.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function applyBuy(button, blockId) {
  const block = button.closest('.buy-block');
  const priceInput = block.querySelector(`#addPrice-${blockId}`); const amountInput = block.querySelector(`#addAmount-${blockId}`);
  const price = parseFloat(priceInput.value); const amount = parseInt(amountInput.value);
  if (isNaN(price) || price <= 0 || isNaN(amount) || amount <= 0) { showNotification('ì¶”ê°€ ë§¤ìˆ˜ê°€ì™€ ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ í° ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error'); return; }
  if (button.disabled) { showNotification('ì´ë¯¸ ë°˜ì˜ëœ ë§¤ìˆ˜ì…ë‹ˆë‹¤.', 'info'); return; }
  appState.purchases.push({ price, amount, id: blockId }); recalculateAndUpdateUI();
  priceInput.disabled = true; amountInput.disabled = true; button.textContent = 'âœ… ë°˜ì˜ë¨'; button.disabled = true;
  const removeButton = block.querySelector('button.secondary'); if(removeButton) removeButton.textContent = 'âŒ ë°˜ì˜ëœ í•­ëª© ì‚­ì œ';
  showNotification(`ì¶”ê°€ ë§¤ìˆ˜ ë°˜ì˜: ${price.toLocaleString()}ì›, ${amount.toLocaleString()}ì£¼`, 'success');
}
function removeBuyBlock(button, blockId) {
    const blockToRemove = button.closest('.buy-block');
    const applyButton = blockToRemove.querySelector('button[onclick^="applyBuy"]');
    const isReflected = applyButton ? applyButton.disabled : false;
    if (isReflected) {
        const purchaseIndex = appState.purchases.findIndex(p => p.id === blockId);
        if (purchaseIndex > -1) {
            if (appState.purchases[purchaseIndex].id.startsWith('initial-')) { showNotification('ìµœì´ˆ ë§¤ìˆ˜ëŠ” ì´ ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "ìµœì´ˆ ë§¤ìˆ˜ ì´ˆê¸°í™”"ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.', 'error'); return; }
            appState.purchases.splice(purchaseIndex, 1);
            if (appState.purchases.length === 0) { toggleInitialPurchaseInputs(false); }
            recalculateAndUpdateUI(); blockToRemove.remove();
            showNotification('ë°˜ì˜ëœ ë§¤ìˆ˜ í•­ëª©ì´ ì‚­ì œë˜ê³  ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else { showNotification('ì‚­ì œí•  í•­ëª© IDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. DOMì—ì„œë§Œ ì œê±°í•©ë‹ˆë‹¤.', 'error'); blockToRemove.remove(); }
    } else { blockToRemove.remove(); showNotification('ì¶”ê°€ ë§¤ìˆ˜ í•­ëª©(ë¯¸ë°˜ì˜)ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); }
}
function clearAdditionalBuys() {
  if (appState.purchases.length === 0) { showNotification('ì´ˆê¸°í™”í•  ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return; }
  if (appState.purchases.length === 1 && appState.purchases[0].id.startsWith('initial-') && dom.additionalInputsContainer.children.length === 0) { showNotification('ì´ˆê¸°í™”í•  ì¶”ê°€ ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return; }
  const initialPurchase = appState.purchases.find(p => p.id && p.id.startsWith('initial-'));
  appState.purchases = initialPurchase ? [initialPurchase] : [];
  dom.additionalInputsContainer.innerHTML = ''; recalculateAndUpdateUI();
  showNotification('ì¶”ê°€ ë§¤ìˆ˜ ì •ë³´ê°€ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}
function updateAggregates() {
  if (appState.purchases.length === 0) { appState.totalAmount = 0; appState.totalInvestedCost = 0; appState.avgBuyPrice = 0; return; }
  let totalAmount = 0, totalCost = 0;
  appState.purchases.forEach(p => {
    const costWithFee = p.price * p.amount * (1 + appState.fees.buyRate); p.costWithFee = costWithFee;
    totalAmount += p.amount; totalCost += costWithFee;
  });
  appState.totalAmount = totalAmount; appState.totalInvestedCost = totalCost;
  appState.avgBuyPrice = totalAmount > 0 ? totalCost / totalAmount : 0;
}
function calculateProfit() {
  if (appState.purchases.length === 0) { dom.profitResultTableDiv.innerHTML = ''; dom.breakEvenDiv.innerHTML = ''; return; }
  const currentPriceStr = dom.currentPriceInput.value; let currentPrice;
  if (currentPriceStr === '') {
      if (appState.currentPrice > 0) { currentPrice = appState.currentPrice; dom.currentPriceInput.value = currentPrice; }
      else if (appState.purchases.length > 0) { currentPrice = appState.purchases[appState.purchases.length - 1].price; dom.currentPriceInput.value = currentPrice; showNotification(`í˜„ì¬ê°€ê°€ ìë™ ì…ë ¥: ${currentPrice.toLocaleString()}ì›`, 'info');}
      else { return; }
  } else { currentPrice = parseFloat(currentPriceStr); }
  if (isNaN(currentPrice) || currentPrice < 0) { showNotification('ì˜¬ë°”ë¥¸ í˜„ì¬ ì£¼ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error'); return; }
  appState.currentPrice = currentPrice;
  const grossMarketValue = currentPrice * appState.totalAmount;
  const netMarketValue = grossMarketValue * (1 - appState.fees.sellRate - appState.fees.taxRate);
  const profitOrLoss = netMarketValue - appState.totalInvestedCost;
  const roi = appState.totalInvestedCost > 0 ? (profitOrLoss / appState.totalInvestedCost) * 100 : 0;
  const colorClass = profitOrLoss >= 0 ? 'positive' : 'negative';
  dom.profitResultTableDiv.innerHTML = `<table><tr><th>êµ¬ë¶„</th><th>ê¸ˆì•¡(ì›) / ë¹„ìœ¨(%)</th></tr><tr><td>ì´ íˆ¬ì ì›ê¸ˆ</td><td>${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td>í˜„ì¬ í‰ê°€ì•¡ (ì„¸ì „)</td><td>${grossMarketValue.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td>ì˜ˆìƒ ìˆœ í‰ê°€ì•¡ (ì„¸í›„)</td><td>${netMarketValue.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td class="${colorClass}">ì˜ˆìƒ ìˆœì†ìµ</td><td class="${colorClass}">${profitOrLoss.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td class="${colorClass}">ì˜ˆìƒ ìˆ˜ìµë¥ </td><td class="${colorClass}">${roi.toFixed(2)}%</td></tr></table>`;
  let breakEvenPrice = 0;
  if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { breakEvenPrice = appState.totalInvestedCost / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate));}
  else if (appState.totalAmount > 0) { breakEvenPrice = Infinity; }
  dom.breakEvenDiv.innerHTML = `ğŸ¯ <strong>ì†ìµë¶„ê¸°ì  ì£¼ê°€: ${breakEvenPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : breakEvenPrice.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})} ì›</strong>`;
}
function clearProfitCalculation() {
  dom.currentPriceInput.value = ''; dom.profitResultTableDiv.innerHTML = ''; dom.breakEvenDiv.innerHTML = '';
  appState.currentPrice = 0; if (appState.purchases.length > 0) updateCharts();
  showNotification('ì†ìµ ê³„ì‚° ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}
function calculateTargetSellPrice() {
  const targetROIStr = dom.targetROIInput.value; let targetROIValue;
  if (targetROIStr === '') { if (appState.targetROI === 0 && dom.targetPriceResultDiv.innerText === '') return; targetROIValue = appState.targetROI; }
  else { targetROIValue = parseFloat(targetROIStr); }
  if (isNaN(targetROIValue)) { showNotification('ëª©í‘œ ìˆ˜ìµë¥ ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.', 'error'); dom.targetPriceResultDiv.innerHTML = ''; dom.targetPriceTableDiv.innerHTML = ''; return; }
  if (appState.purchases.length === 0) { return; }
  if (targetROIValue < -100) { showNotification('ëª©í‘œ ìˆ˜ìµë¥ ì€ -100% ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
  appState.targetROI = targetROIValue;
  const targetNetProfit = appState.totalInvestedCost * (targetROIValue / 100);
  const targetNetMarketValue = appState.totalInvestedCost + targetNetProfit;
  let targetSellPrice = 0;
  if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { targetSellPrice = targetNetMarketValue / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate));}
  else if (appState.totalAmount > 0) { targetSellPrice = Infinity; }
  const colorClass = targetNetProfit >= 0 ? 'positive' : 'negative';
  dom.targetPriceResultDiv.innerText = `ğŸ“Œ ${targetROIValue}% ìˆœìˆ˜ìµì„ ìœ„í•œ ë§¤ë„ ëª©í‘œê°€ëŠ” ${targetSellPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : targetSellPrice.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})} ì›ì…ë‹ˆë‹¤.`;
  dom.targetPriceTableDiv.innerHTML = `<table><tr><th>í•­ëª©</th><th>ê¸ˆì•¡(ì›) / ë¹„ìœ¨(%)</th></tr><tr><td>í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€</td><td>${appState.avgBuyPrice.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td class="${colorClass}">ëª©í‘œ ë§¤ë„ê°€ (${targetROIValue}%)</td><td class="${colorClass}">${targetSellPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : targetSellPrice.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td>ì´ íˆ¬ì ì›ê¸ˆ</td><td>${appState.totalInvestedCost.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td class="${colorClass}">ì˜ˆìƒ ìˆœìˆ˜ìµ</td><td class="${colorClass}">${targetNetProfit.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr><tr><td>ì˜ˆìƒ ì´ ìˆœìì‚° (ë§¤ë„ í›„)</td><td>${targetNetMarketValue.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr></table>`;
}
function clearTargetPriceCalculation() {
    dom.targetROIInput.value = ''; dom.targetPriceResultDiv.innerHTML = ''; dom.targetPriceTableDiv.innerHTML = '';
    appState.targetROI = 0; if (appState.purchases.length > 0) updateCharts();
    showNotification('ë§¤ë„ ëª©í‘œê°€ ê³„ì‚° ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}
function initializeCharts() {
    const getChartTextColors = () => ({ titleColor: isDarkChartElement()?'#e0e0e0':'#333', legendColor: isDarkChartElement()?'#e0e0e0':'#333', tickColor: isDarkChartElement()?'#e0e0e0':'#666', gridColor: isDarkChartElement()?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.1)' });
    const commonChartOptions = (type) => {
        const colors = getChartTextColors();
        let options = { responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: colors.legendColor } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || ''; if (label) label += ': ';
                            const val = context.parsed.y ?? context.raw ?? (type === 'priceComparison' ? context.parsed.x : null) ;
                            if (type === 'pie' || type === 'doughnut') { const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((val / total) * 100).toFixed(2) : 0; return `${context.label}: ${val.toLocaleString('ko-KR')} ì› (${percentage}%)`; }
                            else if (context.dataset.label === 'ë§¤ìˆ˜ ìˆ˜ëŸ‰') { if (val !== null) label += val.toLocaleString() + ' ì£¼'; }
                            else { if (val !== null) label += val.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ì›'; }
                            return label;
                        }
                    }
                }
            }
        };
        if (type === 'line' || type === 'bar' || type === 'priceComparison') {
            options.scales = {
                y: { beginAtZero: (type === 'bar'), ticks: { callback: function(value) { return type === 'bar' ? value.toLocaleString() + ' ì£¼' : value.toLocaleString('ko-KR') + ' ì›'; }, color: colors.tickColor }, grid: { color: colors.gridColor }, title: {display: type === 'bar', text: type === 'bar' ? 'ìˆ˜ëŸ‰(ì£¼)' : '', color: colors.titleColor} },
                x: { ticks: { font: { size: 10 }, color: colors.tickColor }, grid: { color: colors.gridColor } }
            };
             if (type === 'priceComparison') {
                 options.indexAxis = 'y';
                 options.scales = { x: { beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString('ko-KR') + ' ì›'; }, color: colors.tickColor }, grid: { color: colors.gridColor } }, y: { ticks: { color: colors.tickColor }, grid: { color: colors.gridColor } } };
            }
        }
        return options;
    };

    if (dom.avgPriceChartCanvas) { const colors = getChartTextColors(); avgPriceChartInstance = new Chart(dom.avgPriceChartCanvas.getContext('2d'), { type: 'line', data: { labels: [], datasets: [] }, options: { ...commonChartOptions('line'), plugins: { ...commonChartOptions('line').plugins, title: { display: true, text: 'ğŸ“ˆ í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ ë° ê°œë³„ ë§¤ìˆ˜ê°€', color: colors.titleColor } } } }); }
    if (dom.volumeChartCanvas) { const colors = getChartTextColors(); volumeChartInstance = new Chart(dom.volumeChartCanvas.getContext('2d'), { type: 'bar', data: { labels: [], datasets: [] }, options: { ...commonChartOptions('bar'), plugins: { ...commonChartOptions('bar').plugins, title: { display: true, text: 'ğŸ“Š ë§¤ìˆ˜ íšŒì°¨ë³„ ìˆ˜ëŸ‰', color: colors.titleColor }, legend: { display: false } } } }); }
    if (dom.investmentPieChartCanvas) { const colors = getChartTextColors(); investmentPieChartInstance = new Chart(dom.investmentPieChartCanvas.getContext('2d'), { type: 'pie', data: { labels: [], datasets: [{ label: 'ë§¤ìˆ˜ ê¸ˆì•¡ ë¹„ì¤‘', data: [], backgroundColor: [], borderColor: [], borderWidth: 1 }] }, options: { ...commonChartOptions('pie'), plugins: { ...commonChartOptions('pie').plugins, title: { display: true, text: 'ğŸ’° ë§¤ìˆ˜ ê±´ë³„ ê¸ˆì•¡ ë¹„ì¤‘ (%)', color: colors.titleColor }, legend: {position: 'top'} } } }); if (dom.investmentPieChartCanvas) dom.investmentPieChartCanvas.style.display = 'none'; }
if (dom.priceComparisonChartCanvas) { 
        const colors = getChartTextColors(); 
        priceComparisonChartInstance = new Chart(dom.priceComparisonChartCanvas.getContext('2d'), { 
            type: 'bar', 
            data: { 
                labels: ['ì‹œì¥ê°€(ì „ì¼ì¢…ê°€)', 'ë‚˜ì˜ í‰ê· ë‹¨ê°€'], 
                datasets: [{ 
                    label: 'ê°€ê²© ë¹„êµ', 
                    data: [0,0], 
                    backgroundColor: ['rgba(75,192,192,0.7)','rgba(255,159,64,0.7)'], 
                    borderColor:['rgba(75,192,192,1)','rgba(255,159,64,1)'], 
                    borderWidth:1 
                }] 
            }, 
            options: { 
                ...commonChartOptions('priceComparison'), 
                plugins: { 
                    ...commonChartOptions('priceComparison').plugins, 
                    title: {display:true, text:'ğŸ“Š ë‚˜ì˜ í‰ë‹¨ê°€ vs ì‹œì¥ê°€(ì „ì¼ì¢…ê°€)', color: colors.titleColor}, 
                    legend: {display:false} 
                } 
            } 
        }); 
        if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'none'; // ì´ˆê¸°ì— ìˆ¨ê¹€
    }
    updateDarkModeUI(isDarkChartElement()); // ì´ í˜¸ì¶œ ìœ„ì¹˜ëŠ” í•¨ìˆ˜ ì „ì²´ì˜ ë§ˆì§€ë§‰ì— í•œ ë²ˆë§Œ ìˆëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
}

function updateCharts() {
    if (!avgPriceChartInstance && !volumeChartInstance && !investmentPieChartInstance && !historicalPriceChartInstance) return; // historicalPriceChartInstance í™•ì¸ ì¶”ê°€
    const chartLabels = appState.purchases.map((p, i) => i === 0 ? `ìµœì´ˆ(${p.amount}ì£¼)` : `ì¶”ê°€${i}(${p.amount}ì£¼)`);

    // ... (avgPriceChartInstance, volumeChartInstance, investmentPieChartInstance ì—…ë°ì´íŠ¸ëŠ” ì´ì „ê³¼ ë™ì¼) ...
    if (avgPriceChartInstance) { /* ... */ }
    if (volumeChartInstance) { /* ... */ }
    if (investmentPieChartInstance) { /* ... */ }


    // ê¸°ê°„ë³„ ì‹œì„¸ ë° ë‚˜ì˜ í‰ê· ë‹¨ê°€ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    if (historicalPriceChartInstance) {
        if (appState.historicalPrices && appState.historicalPrices.length > 0) {
            const labels = appState.historicalPrices.map(item => {
                // YYYYMMDD -> YY/MM/DD í˜•ì‹ìœ¼ë¡œ ë³€ê²½ (ì˜ˆì‹œ)
                const year = item.date.substring(2, 4);
                const month = item.date.substring(4, 6);
                const day = item.date.substring(6, 8);
                return `${year}/${month}/${day}`;
            });
            const data = appState.historicalPrices.map(item => item.price);

            historicalPriceChartInstance.data.labels = labels;
            historicalPriceChartInstance.data.datasets[0].data = data;
            historicalPriceChartInstance.data.datasets[0].label = appState.fetchedStockInfo.name || 'ì¼ë³„ ì¢…ê°€';


            // í‰ë‹¨ê°€ ì£¼ì„ ì—…ë°ì´íŠ¸
            const avgPriceAnnotation = historicalPriceChartInstance.options.plugins.annotation.annotations.avgBuyPriceLine;
            if (appState.purchases.length > 0 && appState.avgBuyPrice > 0) {
                avgPriceAnnotation.display = true;
                avgPriceAnnotation.yMin = appState.avgBuyPrice;
                avgPriceAnnotation.yMax = appState.avgBuyPrice;
                avgPriceAnnotation.label.content = `ë‚˜ì˜ í‰ë‹¨ê°€: ${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})}ì›`;
            } else {
                avgPriceAnnotation.display = false; // í‰ë‹¨ê°€ ì—†ìœ¼ë©´ ìˆ¨ê¹€
            }
            
            historicalPriceChartInstance.update('none');
            if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'block';
        } else {
            historicalPriceChartInstance.data.labels = [];
            historicalPriceChartInstance.data.datasets[0].data = [];
            historicalPriceChartInstance.options.plugins.annotation.annotations.avgBuyPriceLine.display = false; // ë°ì´í„° ì—†ìœ¼ë©´ í‰ë‹¨ì„ ë„ ìˆ¨ê¹€
            historicalPriceChartInstance.update('none');
            if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'none';
        }
    }
}

function saveData() {
  const dataToSave = { appState: appState, inputs: { initPrice: dom.initPriceInput.value, initAmount: dom.initAmountInput.value, currentPrice: dom.currentPriceInput.value, targetROI: dom.targetROIInput.value, buyFeeRate: dom.buyFeeRateInput.value, sellFeeRate: dom.sellFeeRateInput.value, taxRate: dom.taxRateInput.value, stockCode: dom.stockCodeInput.value }}; // stockCodeInput ì €ì¥ ì¶”ê°€
  localStorage.setItem(LS_KEY_DATA, JSON.stringify(dataToSave));
  showNotification('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}
function loadData() {
  const savedData = localStorage.getItem(LS_KEY_DATA);
  if (!savedData) { resetAllData(false); return; }
  const parsedData = JSON.parse(savedData);
  if (parsedData.appState) {
      const defaultFeesFromDOM = { buyRate: parseFloat(dom.buyFeeRateInput.defaultValue||'0.015')/100, sellRate: parseFloat(dom.sellFeeRateInput.defaultValue||'0.015')/100, taxRate: parseFloat(dom.taxRateInput.defaultValue||'0.2')/100 };
      parsedData.appState.fees = parsedData.appState.fees || defaultFeesFromDOM;
      if (parsedData.appState.purchases && parsedData.appState.purchases.length > 0) { parsedData.appState.purchases.forEach((p, index) => { if (!p.id) { p.id = index === 0 ? `initial-${Date.now()+index}` : `buyBlock-loaded-${Date.now()+index}`; }}); }
      Object.assign(appState, parsedData.appState);
  } else { resetAllData(false); return; }
  if (parsedData.inputs) {
      dom.initPriceInput.value = parsedData.inputs.initPrice || ''; dom.initAmountInput.value = parsedData.inputs.initAmount || '';
      dom.currentPriceInput.value = parsedData.inputs.currentPrice || ''; dom.targetROIInput.value = parsedData.inputs.targetROI || '';
      dom.buyFeeRateInput.value = parsedData.inputs.buyFeeRate || (appState.fees.buyRate*100).toString();
      dom.sellFeeRateInput.value = parsedData.inputs.sellFeeRate || (appState.fees.sellRate*100).toString();
      dom.taxRateInput.value = parsedData.inputs.taxRate || (appState.fees.taxRate*100).toString();
      dom.stockCodeInput.value = parsedData.inputs.stockCode || ''; // stockCodeInput ë³µì›
  } else {
      dom.buyFeeRateInput.value = (appState.fees.buyRate*100).toString(); dom.sellFeeRateInput.value = (appState.fees.sellRate*100).toString(); dom.taxRateInput.value = (appState.fees.taxRate*100).toString();
  }
  loadSettings();
  dom.additionalInputsContainer.innerHTML = '';
  if (appState.purchases && appState.purchases.length > 1) {
    appState.purchases.slice(1).forEach((p) => {
      const block = document.createElement('div'); block.className = 'buy-block'; const blockId = p.id;
      block.innerHTML = `<div class="input-group"><label for="addPrice-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ê°€</label><input type="number" id="addPrice-${blockId}" value="${p.price}" disabled></div><div class="input-group"><label for="addAmount-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰</label><input type="number" id="addAmount-${blockId}" value="${p.amount}" disabled></div><button disabled>âœ… ë°˜ì˜ë¨</button><button class="secondary" onclick="removeBuyBlock(this,'${blockId}')">âŒ ë°˜ì˜ëœ í•­ëª© ì‚­ì œ</button>`;
      dom.additionalInputsContainer.appendChild(block);
    });
  }
  toggleInitialPurchaseInputs(appState.purchases && appState.purchases.length > 0);
  recalculateAndUpdateUI();
  showNotification('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
}
function resetAllData(notify = true) {
  const defaultBuyFee = parseFloat(document.getElementById('buyFeeRate').defaultValue||'0.015')/100;
  const defaultSellFee = parseFloat(document.getElementById('sellFeeRate').defaultValue||'0.015')/100;
  const defaultTaxRate = parseFloat(document.getElementById('taxRate').defaultValue||'0.2')/100;
  appState = { purchases:[], avgBuyPrice:0, totalAmount:0, totalInvestedCost:0, fees:{buyRate:defaultBuyFee, sellRate:defaultSellFee, taxRate:defaultTaxRate}, currentPrice:0, targetROI:0, fetchedStockInfo:{code:'',name:'',price:0,date:''} };
  dom.initPriceInput.value = ''; dom.initAmountInput.value = ''; toggleInitialPurchaseInputs(false);
  dom.additionalInputsContainer.innerHTML = ''; dom.stockCodeInput.value = '';
  dom.buyFeeRateInput.value = dom.buyFeeRateInput.defaultValue||'0.015'; dom.sellFeeRateInput.value = dom.sellFeeRateInput.defaultValue||'0.015'; dom.taxRateInput.value = dom.taxRateInput.defaultValue||'0.2';
  recalculateAndUpdateUI();
  if (notify && localStorage.getItem(LS_KEY_DATA)) { localStorage.removeItem(LS_KEY_DATA); showNotification('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
  else if (!localStorage.getItem(LS_KEY_DATA) && !notify && dom.summaryResultDiv.innerHTML.includes('ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤')) { showNotification('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.', 'info');}
}
function downloadExcel() { /* ... (ì´ì „ê³¼ ë™ì¼, p.id?.substring(0,8) ì™€ ê°™ì´ id ì¡´ì¬ í™•ì¸ ì¶”ê°€) ... */
  if (appState.purchases.length === 0) { showNotification('ì—‘ì…€ë¡œ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
  const today = new Date(); const dateString = `${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}`;
  const fileName = `ë¬¼íƒ€ê¸°ê³„ì‚°_${dateString}.xlsx`;
  const ws_data = [ /* ... */ ]; // ì´ì „ê³¼ ë™ì¼í•˜ê²Œ êµ¬ì„±
  // ... (ì—‘ì…€ ë°ì´í„° êµ¬ì„± ë¡œì§, p.idê°€ ì—†ì„ ê²½ìš° 'N/A' ì²˜ë¦¬ ë˜ëŠ” ì•ˆì „í•˜ê²Œ ì ‘ê·¼)
  let cumulativeTotalCost = 0, cumulativeTotalAmount = 0;
  appState.purchases.forEach((p, i) => { /* ... p.id null ì²´í¬ ì¶”ê°€ ... */
    const idDisplay = p.id ? p.id.substring(0,8) : 'N/A';
    const costWithFee = p.costWithFee; cumulativeTotalCost += costWithFee; cumulativeTotalAmount += p.amount;
    const cumulativeAvgPrice = cumulativeTotalAmount > 0 ? cumulativeTotalCost / cumulativeTotalAmount : 0;
    ws_data.push([ i === 0 ? `ìµœì´ˆ ë§¤ìˆ˜ (ID: ${idDisplay})` : `ì¶”ê°€ ë§¤ìˆ˜ ${i} (ID: ${idDisplay})`, p.price, p.amount, costWithFee.toFixed(2), cumulativeAvgPrice.toFixed(2) ]);
  });
  // ... (ë‚˜ë¨¸ì§€ ì—‘ì…€ ë°ì´í„° êµ¬ì„±)
  const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(ws_data);
  if (ws_data.length > 5 && ws_data[5] && ws_data[5].length > 0) { const colSpecs = ws_data[5].map((_, i) => { let maxLen = 0; ws_data.forEach(row => { if (row[i] && String(row[i]).length > maxLen) maxLen = String(row[i]).length; }); return { wch: Math.max(10, maxLen + 2) }; }); ws['!cols'] = colSpecs; }
  XLSX.utils.book_append_sheet(wb, ws, 'íˆ¬ìê³„ì‚°ë‚´ì—­'); XLSX.writeFile(wb, fileName);
  showNotification('ì—‘ì…€ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem(LS_KEY_DARK_MODE, isDark ? 'on' : 'off');
  updateDarkModeUI(isDark);
}

function updateDarkModeUI(isDark) {
    dom.darkModeBtn.innerText = isDark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ON' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON';
    const colors = {
        titleColor: isDark ? '#e0e0e0' : '#333', legendColor: isDark ? '#e0e0e0' : '#333',
        tickColor: isDark ? '#e0e0e0' : '#666', gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
    };
    [avgPriceChartInstance, volumeChartInstance, investmentPieChartInstance].forEach(chart => {
        if (chart) {
            if(chart.options.plugins.title) chart.options.plugins.title.color = colors.titleColor;
            if(chart.options.plugins.legend) chart.options.plugins.legend.labels.color = colors.legendColor;
            if(chart.options.scales){
                if(chart.options.scales.x){
                    chart.options.scales.x.ticks.color = colors.tickColor;
                    chart.options.scales.x.grid.color = colors.gridColor;
                    if(chart.options.scales.x.title) chart.options.scales.x.title.color = colors.titleColor;
                }
                if(chart.options.scales.y){
                    chart.options.scales.y.ticks.color = colors.tickColor;
                    chart.options.scales.y.grid.color = colors.gridColor;
                    if(chart.options.scales.y.title) chart.options.scales.y.title.color = colors.titleColor;
                }
            }
            chart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒ‰ìƒ ë³€ê²½ ë°˜ì˜
        }
    });
}
</script>
</body>
</html>
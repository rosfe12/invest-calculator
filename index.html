<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° - ì •í™•í•œ í‰ê· ë‹¨ê°€ ë° íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° (Ver.2.6.5 ìˆ˜ì •)</title>
  <meta name="description" content="ì£¼ì‹, ì½”ì¸ íˆ¬ì ì‹œ ë¬¼íƒ€ê¸°(ì¶”ê°€ë§¤ìˆ˜)ë¡œ ë³€í•˜ëŠ” í‰ê·  ë§¤ìˆ˜ë‹¨ê°€, ì´ íˆ¬ìê¸ˆì•¡, ì˜ˆìƒ ìˆ˜ìµë¥  ë° ì†ìµë¶„ê¸°ì ì„ ê°„í¸í•˜ê²Œ ê³„ì‚°í•˜ê³  ì‹œê°í™”ëœ ì°¨íŠ¸ë¡œ í™•ì¸í•˜ì„¸ìš”. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •, ì „ì¼ ì¢…ê°€ ì¡°íšŒ ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤.">
  <link rel="canonical" href="https://rosfe12.github.io/" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest/dist/chartjs-plugin-annotation.min.js"></script>  
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° - íˆ¬ì ìˆ˜ìµë¥  ë° í‰ê· ë‹¨ê°€ ê³„ì‚°",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "KRW" },
    "description": "ì£¼ì‹, ì½”ì¸ íˆ¬ì ì‹œ ì¶”ê°€ ë§¤ìˆ˜(ë¬¼íƒ€ê¸°)ë¥¼ í†µí•´ í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ë¥¼ ë‚®ì¶”ê³  íˆ¬ì ìˆ˜ìµë¥ , ì†ìµë¶„ê¸°ì ì„ ê³„ì‚°í•˜ëŠ” ì›¹ ê³„ì‚°ê¸°ì…ë‹ˆë‹¤. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •, ì „ì¼ ì¢…ê°€ ì¡°íšŒ(ì¢…ëª©ëª…/ì½”ë“œ ê²€ìƒ‰), ë‹¤ì–‘í•œ ì°¨íŠ¸ ì‹œê°í™”ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
    "url": "https://rosfe12.github.io/",
    "keywords": "ë¬¼íƒ€ê¸° ê³„ì‚°ê¸°, ì£¼ì‹ ê³„ì‚°ê¸°, ì½”ì¸ ê³„ì‚°ê¸°, í‰ê· ë‹¨ê°€ ê³„ì‚°ê¸°, í‰ë‹¨ê°€ ê³„ì‚°ê¸°, íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚°ê¸°, ìˆ˜ìµë¥  ê³„ì‚°ê¸°, ì†ìµë¶„ê¸°ì  ê³„ì‚°ê¸°, ì¶”ê°€ë§¤ìˆ˜ ê³„ì‚°ê¸°, ì£¼ì‹ ì‹œì„¸ ì¡°íšŒ, KRX ì‹œì„¸, ì¢…ëª©ëª… ê²€ìƒ‰"
  }
  </script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; max-width: 800px; margin: auto; transition: background-color 0.3s, color 0.3s; }
    section { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, button { margin: 5px 0; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    button { background-color: #4CAF50; color: white; cursor: pointer; border: none; }
    button:hover { opacity: 0.9; }
    button.secondary { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
    table, th, td { border: 1px solid #ccc; }
    th { background: #f2f2f2; white-space: nowrap; }
    td, th { padding: 6px; text-align: center; }
    .positive { color: red; font-weight: bold; }
    .negative { color: blue; font-weight: bold; }
    canvas { margin-top: 20px; max-width: 100%; }
    .buy-block { margin-bottom: 10px; padding: 10px; border: 1px dashed #aaa; border-radius: 6px; background: #f9f9f9; }
    body.dark { background-color: #121212; color: #e0e0e0; }
    body.dark section { background-color: #1e1e1e; border-color: #444; }
    body.dark input, body.dark button.secondary { background-color: #2c2c2c; color: #fff; border: 1px solid #555; }
    body.dark table, body.dark th, body.dark td { border-color: #555; }
    body.dark th { background-color: #2a2a2a; }
    body.dark .buy-block { background-color: #2a2a2a; border-color: #555; }
    .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 5px; color: white; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-size: 0.9em; }
    .notification.show { opacity: 1; bottom: 30px; }
    .notification.success { background-color: #4CAF50; }
    .notification.error { background-color: #f44336; }
    .notification.info { background-color: #2196F3; }
    .input-group { display: flex; gap: 10px; align-items: center; }
    .input-group label { flex-basis: 120px; margin-top: 0; }
    .input-group input { flex-grow: 1; }
    #purchaseHistoryTableContainer table td, #purchaseHistoryTableContainer table th { font-size: 0.85em; padding: 5px;}
    .intro-text { text-align: left; margin-bottom: 25px; padding: 10px 0; line-height: 1.6; font-size: 0.95em;}
    body.dark .intro-text { color: #c0c0c0; }
    .chart-container { position: relative; margin: 20px auto; width: 100%; }
    #avgPriceChartContainer { height: 400px; max-width: 800px; }
    #volumeChartContainer { height: 400px; max-width: 800px; margin-top: 40px; }
    #investmentPieChartContainer { height: 400px; max-width: 600px; }
    #priceComparisonChartContainer { height: 300px; max-width: 800px; }
    @media (max-width: 600px) {
      body { padding: 10px; } section { padding: 10px; } h1 { font-size: 1.5em; } h3 { font-size: 1.1em; }
      input, button { font-size: 1em; padding: 12px 10px; } button { margin-top: 8px; }
      table td, table th { font-size: 0.8em; padding: 4px; }
      #purchaseHistoryTableContainer table td, #purchaseHistoryTableContainer table th { font-size: 0.75em; padding: 3px;}
      .input-group { flex-direction: column; align-items: stretch; }
      .input-group label { flex-basis: auto; margin-bottom: 5px; } .intro-text { font-size: 0.9em; }
      #avgPriceChartContainer { height: 300px; } #volumeChartContainer { height: 300px; }
      #investmentPieChartContainer { height: 300px; } #priceComparisonChartContainer { height: 250px; }
    }
  </style>
</head>
<body>

<h1 style="text-align: center;">ğŸ’¸ ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° Ver.2.6.5 (ìˆ˜ì •): íˆ¬ì ìˆ˜ìµë¥  & í‰ê· ë‹¨ê°€ ë¶„ì„</h1>
<div style="text-align: right; margin-bottom: 10px;">
  <button id="darkModeBtn" onclick="toggleDarkMode()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON</button>
</div>
<div class="intro-text">
    ë³¸ ê³„ì‚°ê¸°ëŠ” ìµœì´ˆ ë§¤ìˆ˜ ë° ì—¬ëŸ¬ ì°¨ë¡€ì˜ ì¶”ê°€ ë§¤ìˆ˜ ì‹œ ë³€ë™ë˜ëŠ” <strong>í‰ê·  ë‹¨ê°€, ì´ íˆ¬ìê¸ˆì•¡, ì˜ˆìƒ ìˆ˜ìµë¥ , ê·¸ë¦¬ê³  ë§¤ìš° ì¤‘ìš”í•œ ì†ìµë¶„ê¸°ì (BEP)</strong> ë“±ì„ ì†ì‰½ê²Œ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.<br>
    ë˜í•œ, ì…ë ¥ëœ ë§¤ìˆ˜ ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ <strong>í‰ê·  ë‹¨ê°€ ë³€ë™ ì¶”ì´, íšŒì°¨ë³„ ë§¤ìˆ˜ëŸ‰, ë§¤ìˆ˜ ê¸ˆì•¡ ë¹„ì¤‘</strong>ì„ ì§ê´€ì ì¸ ì°¨íŠ¸ë¡œ ì‹œê°í™”í•˜ì—¬ íˆ¬ì ê²°ì •ì— ë„ì›€ì„ ë“œë¦½ë‹ˆë‹¤.<br>
    ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •ì„ í†µí•´ ì‹¤ì œ íˆ¬ì í™˜ê²½ê³¼ ìœ ì‚¬í•œ ì¡°ê±´ì—ì„œ ë”ìš± ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì–´ë³´ì‹œê³ , <strong>ì „ì¼ ì¢…ê°€ ì¡°íšŒ ê¸°ëŠ¥(ì¢…ëª©ì½”ë“œ/ì¢…ëª©ëª… ê²€ìƒ‰ ì§€ì›)</strong>ìœ¼ë¡œ í˜„ì¬ê°€ ì…ë ¥ì˜ í¸ì˜ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”!
</div>

<section id="settingsSection">
    <h3>âš™ï¸ ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •</h3>
    <div class="input-group"> <label for="buyFeeRate">ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ (%)</label> <input type="number" id="buyFeeRate" value="0.015" step="0.001" min="0"> </div>
    <div class="input-group"> <label for="sellFeeRate">ë§¤ë„ ìˆ˜ìˆ˜ë£Œ (%)</label> <input type="number" id="sellFeeRate" value="0.015" step="0.001" min="0"> </div>
    <div class="input-group"> <label for="taxRate">ì„¸ê¸ˆ (%)</label> <input type="number" id="taxRate" value="0.2" step="0.01" min="0"> </div>
    <button id="setFeesToZeroBtn" class="secondary" style="margin-top: 10px;">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ë¯¸ì ìš© (0%ë¡œ ì„¤ì •)</button>
    <small style="display:block; color:gray; margin-top:5px;"> â€» êµ­ë‚´ ì£¼ì‹ ê¸°ì¤€ ê¸°ë³¸ê°’ (ì¦ê¶Œì‚¬ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë©°, ì„¸ê¸ˆì€ êµ­ê°€/ìƒí’ˆë³„ë¡œ ìƒì´) </small>
</section>

<section id="initialPurchaseSection">
  <h3>â‘  ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥</h3>
  <div class="input-group"> <label for="initPrice">ìµœì´ˆ ë§¤ìˆ˜ê°€ (ì›)</label> <input type="number" id="initPrice" min="0"> </div>
  <div class="input-group"> <label for="initAmount">ìµœì´ˆ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label> <input type="number" id="initAmount" min="1"> </div>
  <button id="setInitialPurchaseBtn" onclick="setInitialPurchase()">âœ” ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥</button>
  <button id="clearInitialPurchaseBtn" class="secondary" onclick="clearInitialPurchase()" style="display:none;">ğŸ§¹ ìµœì´ˆ ë§¤ìˆ˜ ì´ˆê¸°í™”</button>
</section>

<section>
  <h3>â‘¡ ì¶”ê°€ ë§¤ìˆ˜ ì…ë ¥</h3>
  <div id="additionalInputs"></div>
  <button onclick="addBuyBlock()">â• ì¶”ê°€ ë§¤ìˆ˜ í•­ëª© ì¶”ê°€</button>
  <button class="secondary" onclick="clearAdditionalBuys()">â– ì¶”ê°€ ë§¤ìˆ˜ ì „ì²´ ì´ˆê¸°í™”</button>
</section>

<section>
  <h3>â‘¢ í‰ê·  ë‹¨ê°€ & ì†ìµ ê³„ì‚°</h3>
  <div id="summaryResult"></div>
  <div class="input-group" style="margin-top: 15px; margin-bottom: 5px;">
    <label for="stockCodeInput" style="flex-basis: auto; margin-right: 10px;">ì¢…ëª©ì½”ë“œ/ëª…:</label>
    <input type="text" id="stockCodeInput" placeholder="ì¢…ëª©ì½”ë“œ(6ìë¦¬) ë˜ëŠ” ì¢…ëª©ëª… ì…ë ¥">
  </div>
  <div class="input-group" style="margin-top: 5px; margin-bottom: 5px;">
    <label for="historicalDaysInput" style="flex-basis: auto; margin-right: 10px;">ì¡°íšŒ ê¸°ê°„(ì¼):</label>
    <input type="number" id="historicalDaysInput" value="90" min="1" max="365" style="width: 80px; flex-grow:0;">  
    <button id="fetchPriceBtn" class="secondary" style="width: auto; padding: 10px 15px; margin-left: 5px; flex-shrink: 0;">ğŸ“ˆ ê¸°ê°„ì‹œì„¸ ì¡°íšŒ</button>
  </div>
  <div class="input-group">
    <label for="currentPriceInput">í˜„ì¬(ë˜ëŠ” ê¸°ì¤€) ì£¼ê°€ (ì›):</label>
    <input type="number" id="currentPriceInput" min="0">
  </div>
  <small style="display:block; color:gray; margin-bottom:5px;"> â€» "ê¸°ê°„ì‹œì„¸ ì¡°íšŒ" ì‹œ ìµœì‹ ì¼ ì¢…ê°€ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤. ì§ì ‘ ê¸°ì¤€ ì£¼ê°€ë¥¼ ì…ë ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. </small>
  <button onclick="calculateProfit()">ğŸ“ˆ ì†ìµ ê³„ì‚°</button>
  <button class="secondary" onclick="clearProfitCalculation()">ğŸ“‰ ì†ìµ ê³„ì‚° ì´ˆê¸°í™”</button>
  <div id="profitResultTable"></div>
  <div id="breakEven" style="margin-top: 10px;"></div>
</section>

<section>
  <h3>â‘£ ëª©í‘œ ìˆ˜ìµë¥  ê¸°ë°˜ ë§¤ë„ ê°€ê²© ê³„ì‚°</h3>
  <div class="input-group"> <label for="targetROI">ëª©í‘œ ìˆ˜ìµë¥  (%)</label> <input type="number" id="targetROI" min="0"> </div>
  <button onclick="calculateTargetSellPrice()">ğŸ¯ ë§¤ë„ ëª©í‘œê°€ ê³„ì‚°</button>
  <div id="targetPriceResult"></div>
  <div id="targetPriceTable"></div>
</section>

<section id="purchaseHistorySection">
  <h3>â‘¤ ìƒì„¸ ë§¤ìˆ˜ ë‚´ì—­</h3>
  <div id="purchaseHistoryTableContainer"></div>
</section>

<section>
  <h3>â‘¥ ê¸°ê°„ë³„ ì‹œì„¸ ë° ë‚˜ì˜ í‰ê· ë‹¨ê°€ ë¹„êµ</h3>
  <div class="chart-container" id="priceComparisonChartContainer">  
    <canvas id="priceComparisonChart"></canvas>  
  </div>
</section>

<section>
  <h3>â‘¦ ë°ì´í„° ì €ì¥ ë° ì°¨íŠ¸ ì‹œê°í™”</h3>
  <button onclick="saveData()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
  <button class="secondary" onclick="loadData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ë¡œ ì €ì¥</button>
  <button class="secondary" onclick="resetAllData()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
</section>

<div class="chart-container" id="avgPriceChartContainer">
    <canvas id="avgPriceChart"></canvas>
</div>
<div class="chart-container" id="volumeChartContainer">
    <canvas id="volumeChart"></canvas>
</div>
<section>
  <h3>â‘§ íˆ¬ì ë¹„ì¤‘ (ë§¤ìˆ˜ ê¸ˆì•¡ ê¸°ì¤€)</h3>
  <div class="chart-container" id="investmentPieChartContainer">
    <canvas id="investmentPieChart"></canvas>
  </div>
</section>

<div id="notificationArea" class="notification"></div>


<script>

// --- Constants ---
const LS_KEY_DATA = "investmentCalculatorData_v2_6_6"; // Version updated
const LS_KEY_DARK_MODE = "investmentCalculatorDarkMode_v2_6_6"; // Version updated
const DATA_GO_KR_API_KEY = 'y0pPGOvyGt483NgWSHJx4MKR9B0iUY2a3kul4wYFxbyH85zaR2hDNhY5OilDkfj%2F9M26UOZeUZJuTcZWntB6Rw%3D%3D'; 

// --- DOM Elements Cache ---
const dom = {};

// --- Application State ---
let appState = {
  purchases: [], avgBuyPrice: 0, totalAmount: 0, totalInvestedCost: 0,
  fees: { buyRate: 0.00015, sellRate: 0.00015, taxRate: 0.002 }, // Default values
  currentPrice: 0, // í˜„ì¬ê°€ ì…ë ¥ í•„ë“œ ê°’ ë˜ëŠ” API ì¡°íšŒ ê°’ (ì†ìµê³„ì‚° ì‹œ ì‚¬ìš©)
  targetROI: 0,    // ëª©í‘œìˆ˜ìµë¥  ì…ë ¥ í•„ë“œ ê°’ (ëª©í‘œê°€ê³„ì‚° ì‹œ ì‚¬ìš©)
  fetchedStockInfo: { code: '', name: '', price: 0, date: '' },
  historicalPrices: [],
  profitCalculationResults: null,      // ì†ìµ ê³„ì‚° ê²°ê³¼ ì €ì¥
  targetPriceCalculationResults: null  // ëª©í‘œê°€ ê³„ì‚° ê²°ê³¼ ì €ì¥
};

// --- Chart Instances ---
let avgPriceChartInstance = null;
let volumeChartInstance = null;
let investmentPieChartInstance = null;
let historicalPriceChartInstance = null;  

// --- Helper Functions ---
function showNotification(message, type = 'info', details = '') {
    const notificationAreaEl = dom.notificationArea; // Ensure dom.notificationArea is cached
    if (!notificationAreaEl) {
      console.error("Notification area not found in DOM for message:", message);
      return;
    }
    notificationAreaEl.textContent = `${message}${details ? ' (ìì„¸íˆ: ì½˜ì†” ì°¸ê³ )' : ''}`;
    notificationAreaEl.className = `notification ${type} show`;
    if (details) console.warn(`ìƒì„¸ ì •ë³´: ${details}`);
    setTimeout(() => notificationAreaEl.classList.remove('show'), 4000);
}

function getChartTextColors() {
    const isDark = document.body.classList.contains('dark');
    return {
        titleColor: isDark ? '#e0e0e0' : '#333',
        legendColor: isDark ? '#e0e0e0' : '#333',
        tickColor: isDark ? '#e0e0e0' : '#666',
        gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
    };
}

/**
 * Chart.js ì˜µì…˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” í†µí•© í•¨ìˆ˜
 */
function createChartOptions(chartType, titleText = '', specificOptions = {}) {
    const colors = getChartTextColors();
    let baseOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: {
            legend: { labels: { color: colors.legendColor } },
            title: { display: !!titleText, text: titleText, color: colors.titleColor, font: { size: 14, weight: 'bold' } },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let datasetLabel = context.dataset.label || '';
                        let currentLabel = context.label || '';
                        let valueToShow;
                        let prefix = datasetLabel ? datasetLabel + ': ' : (currentLabel && (chartType === 'pie' || chartType === 'doughnut') ? currentLabel + ': ' : '');

                        if (chartType === 'pie' || chartType === 'doughnut') {
                            valueToShow = context.raw;
                            const total = context.chart.getDatasetMeta(0).total;
                            const percentage = total > 0 ? ((valueToShow / total) * 100).toFixed(2) : 0;
                            return `${prefix}${valueToShow.toLocaleString('ko-KR')} ì› (${percentage}%)`;
                        } else if (datasetLabel === 'ë§¤ìˆ˜ ìˆ˜ëŸ‰' || (context.dataset.yAxisID === 'yAmount' && chartType === 'bar')) {
                            valueToShow = context.parsed.y;
                            if (valueToShow !== null && valueToShow !== undefined) return `${prefix}${valueToShow.toLocaleString()} ì£¼`;
                        } else {
                            valueToShow = context.parsed.y;
                            if (valueToShow !== null && valueToShow !== undefined) return `${prefix}${valueToShow.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›`;
                        }
                        return prefix + 'ë°ì´í„° ì—†ìŒ';
                    }
                }
            }
        },
        scales: {}
    };

    if (chartType === 'line' || chartType === 'bar' || chartType === 'historicalLine' || chartType === 'scatter') {
        baseOptions.scales = {
            x: { ticks: { font: { size: 10 }, color: colors.tickColor, maxRotation: 70, minRotation: 70 }, grid: { color: colors.gridColor } },
            y: {
                beginAtZero: (chartType === 'bar' || (chartType === 'historicalLine' && appState.historicalPrices && appState.historicalPrices.length > 0 && !appState.historicalPrices.some(p => p.price < 0))),
                ticks: { callback: function(value) { return chartType === 'bar' ? value.toLocaleString() + ' ì£¼' : value.toLocaleString('ko-KR') + ' ì›'; }, color: colors.tickColor },
                grid: { color: colors.gridColor },
                title: { display: chartType === 'bar', text: chartType === 'bar' ? 'ìˆ˜ëŸ‰(ì£¼)' : '', color: colors.titleColor }
            }
        };
        if (chartType === 'historicalLine' || chartType === 'scatter') {
             if (baseOptions.scales.y) baseOptions.scales.y.beginAtZero = false;
        }
        if (chartType === 'historicalLine') {
            if (baseOptions.scales.x) baseOptions.scales.x.type = 'category';
        }
    } else if (chartType === 'pie' || chartType === 'doughnut') {
        delete baseOptions.scales;
    }

    if (specificOptions.plugins) {
        for (const pluginKey in specificOptions.plugins) {
            if (baseOptions.plugins[pluginKey] && typeof baseOptions.plugins[pluginKey] === 'object' && !Array.isArray(baseOptions.plugins[pluginKey]) && specificOptions.plugins[pluginKey] !== null && typeof specificOptions.plugins[pluginKey] === 'object') {
                baseOptions.plugins[pluginKey] = { ...baseOptions.plugins[pluginKey], ...specificOptions.plugins[pluginKey] };
            } else { baseOptions.plugins[pluginKey] = specificOptions.plugins[pluginKey]; }
        }
        delete specificOptions.plugins;
    }
    if (specificOptions.scales) {
        for (const scaleKey in specificOptions.scales) {
            if (baseOptions.scales[scaleKey] && typeof baseOptions.scales[scaleKey] === 'object' && specificOptions.scales[scaleKey] !== null && typeof specificOptions.scales[scaleKey] === 'object') {
                baseOptions.scales[scaleKey] = { ...baseOptions.scales[scaleKey], ...specificOptions.scales[scaleKey] };
            } else { baseOptions.scales[scaleKey] = specificOptions.scales[scaleKey]; }
        }
        delete specificOptions.scales;
    }
    for (const key in specificOptions) { baseOptions[key] = specificOptions[key]; }
    return baseOptions;
}


// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {  
  cacheDOMElements(); 
  
  let chartLibrariesAvailable = false;
  if (typeof Chart !== 'undefined' && typeof Chart.register === 'function' && typeof ChartJsPluginAnnotation !== 'undefined') {
    try {
        Chart.register(ChartJsPluginAnnotation);
        console.log('ChartJsPluginAnnotation registered successfully.');
        chartLibrariesAvailable = true;
    } catch (chartRegisterError) {
        console.error('Error registering ChartJsPluginAnnotation:', chartRegisterError);
        showNotification('ì°¨íŠ¸ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', 'error', chartRegisterError.message);
    }
  } else {
    console.error('Chart or ChartJsPluginAnnotation not defined.');
    showNotification('ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¼ë¶€ ì°¨íŠ¸ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error', 'Chart.js or Annotation plugin missing');
  }

  initializeFeeEventListeners();
  loadSettings(); 
  loadData(); // This calls recalculateAndUpdateUI which now calls updateCharts

  if (chartLibrariesAvailable) {
    initializeCharts();
  } else {
    console.warn("Chart libraries not available. Skipping chart initialization.");
    if(dom.avgPriceChartContainer) dom.avgPriceChartContainer.style.display = 'none';
    if(dom.volumeChartContainer) dom.volumeChartContainer.style.display = 'none';
    if(dom.investmentPieChartContainer) dom.investmentPieChartContainer.style.display = 'none';
    if(dom.priceComparisonChartContainer) dom.priceComparisonChartContainer.style.display = 'none';
  }
  
  updateDarkModeUI(localStorage.getItem(LS_KEY_DARK_MODE) === 'on');
  
  if(dom.setFeesToZeroBtn) dom.setFeesToZeroBtn.addEventListener('click', setFeesToZeroAndRecalculate);
  
  if (dom.fetchPriceBtn) {
      dom.fetchPriceBtn.addEventListener('click', async () => {
          const searchInput = dom.stockCodeInput.value.trim();
          const daysValue = parseInt(dom.historicalDaysInput.value);
          if (!searchInput) {
              showNotification('ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return;
          }
          if (isNaN(daysValue) || daysValue < 1 || daysValue > 365) {
              showNotification('ì¡°íšŒ ê¸°ê°„ì€ 1ì¼ì—ì„œ 365ì¼ ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return;
          }
          await fetchHistoricalStockData(searchInput, daysValue);
      });
  }
});

function cacheDOMElements() {
  dom.buyFeeRateInput = document.getElementById('buyFeeRate');
  dom.sellFeeRateInput = document.getElementById('sellFeeRate');
  dom.taxRateInput = document.getElementById('taxRate');
  dom.setFeesToZeroBtn = document.getElementById('setFeesToZeroBtn');
  dom.initPriceInput = document.getElementById('initPrice');
  dom.initAmountInput = document.getElementById('initAmount');
  dom.setInitialPurchaseBtn = document.getElementById('setInitialPurchaseBtn');
  dom.clearInitialPurchaseBtn = document.getElementById('clearInitialPurchaseBtn');
  dom.initialPurchaseSection = document.getElementById('initialPurchaseSection');
  dom.additionalInputsContainer = document.getElementById('additionalInputs');
  dom.summaryResultDiv = document.getElementById('summaryResult');
  dom.stockCodeInput = document.getElementById('stockCodeInput');
  dom.historicalDaysInput = document.getElementById('historicalDaysInput');
  dom.fetchPriceBtn = document.getElementById('fetchPriceBtn');
  dom.currentPriceInput = document.getElementById('currentPriceInput');
  dom.profitResultTableDiv = document.getElementById('profitResultTable');
  dom.breakEvenDiv = document.getElementById('breakEven');
  dom.targetROIInput = document.getElementById('targetROI');
  dom.targetPriceResultDiv = document.getElementById('targetPriceResult');
  dom.targetPriceTableDiv = document.getElementById('targetPriceTable');
  dom.notificationArea = document.getElementById('notificationArea');
  dom.darkModeBtn = document.getElementById('darkModeBtn');
  dom.avgPriceChartCanvas = document.getElementById('avgPriceChart');
  dom.volumeChartCanvas = document.getElementById('volumeChart');
  dom.investmentPieChartCanvas = document.getElementById('investmentPieChart');
  dom.purchaseHistoryTableContainer = document.getElementById('purchaseHistoryTableContainer');
  dom.priceComparisonChartCanvas = document.getElementById('priceComparisonChart');  
  
  dom.avgPriceChartContainer = document.getElementById('avgPriceChartContainer');
  dom.volumeChartContainer = document.getElementById('volumeChartContainer');
  dom.investmentPieChartContainer = document.getElementById('investmentPieChartContainer');
  dom.priceComparisonChartContainer = document.getElementById('priceComparisonChartContainer');
}

async function fetchStockAPI(searchInput, days) {
    const today = new Date();
    const endDate = formatDate(today, -1); // ì–´ì œê¹Œì§€ ì¡°íšŒ
    const startDate = formatDate(today, -days); // ì¡°íšŒ ê¸°ê°„ ì‹œì‘ì¼
    // API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ í™˜ê²½ ë³€ìˆ˜ ë“±ìœ¼ë¡œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ê²½ìš° ê²½ê³ 
    if (DATA_GO_KR_API_KEY === 'YOUR_DATA_GO_KR_API_KEY' || !DATA_GO_KR_API_KEY) {
        showNotification('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‹œì„¸ ì¡°íšŒê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error', 'API Key Missing');
        throw new Error('API í‚¤ ë¯¸ì„¤ì •');
    }
    const searchParamKey = /^\d{6}$/.test(searchInput) ? 'likeSrtnCd' : 'likeItmsNm'; // ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª… êµ¬ë¶„
    const apiUrl = `https://apis.data.go.kr/1160100/service/GetStockSecuritiesInfoService/getStockPriceInfo?serviceKey=${DATA_GO_KR_API_KEY}&numOfRows=${Math.max(days + 20, 100)}&pageNo=1&resultType=json&${searchParamKey}=${encodeURIComponent(searchInput)}&beginBasDt=${startDate}&endBasDt=${endDate}`;
    
    try {
        const response = await fetch(apiUrl);
        const text = await response.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ìŒ
        return { ok: response.ok, status: response.status, text: text };
    } catch (networkError) {
        console.error("API Fetch Network Error:", networkError);
        showNotification('API í˜¸ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ', 'error', networkError.message);
        throw networkError; // ì˜¤ë¥˜ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ í˜¸ì¶œí•œ ìª½ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•¨
    }
}

function parseStockResponse(text, status) {
    if (text.trim().startsWith('<')) { // XML ì‘ë‹µ ì˜ˆì™¸ ì²˜ë¦¬
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(text, "text/xml");
      const errorMsgNode = xmlDoc.querySelector("resultMsg") || xmlDoc.querySelector("ERROR_MSG") || xmlDoc.querySelector("cmmMsgHeader > returnReasonCode");
      const errorMsg = errorMsgNode ? errorMsgNode.textContent : 'XML ì‘ë‹µ ì˜¤ë¥˜';
      console.error("Received XML response:", text);
      throw new Error(`API ì˜¤ë¥˜ (${status}): ${errorMsg}`);
    }
    try {
        const data = JSON.parse(text);
        if (data.response?.header?.resultCode !== '00') {
            throw new Error(data.response?.header?.resultMsg || `API ì²˜ë¦¬ ì˜¤ë¥˜ (ì½”ë“œ: ${data.response?.header?.resultCode})`);
        }
        const items = data.response?.body?.items?.item || [];
        return Array.isArray(items) ? items : (items ? [items] : []); // í•­ìƒ ë°°ì—´ ë°˜í™˜
    } catch (parseError) {
        console.error("JSON Parsing Error or invalid API structure:", parseError, "Response Text:", text);
        throw new Error(`ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${parseError.message}`);
    }
}

async function fetchHistoricalStockData(searchInput, days) {
    if (!dom.fetchPriceBtn) return;
    dom.fetchPriceBtn.disabled = true;
    dom.fetchPriceBtn.textContent = 'ì¡°íšŒ ì¤‘...';
    showNotification('ê¸°ê°„ ì‹œì„¸ ì¡°íšŒ ì¤‘...', 'info');
    
    try {
        const { ok, status, text } = await fetchStockAPI(searchInput, days);
        if (!ok) {
            // fetchStockAPI ë‚´ë¶€ì—ì„œ XML ë“±ì„ íŒŒì‹± ì‹œë„ ì „ì— ì—¬ê¸°ì„œ ìƒíƒœ ì½”ë“œë¡œ ë¨¼ì € ê±°ë¥¼ ìˆ˜ ìˆìŒ
             if (text.trim().startsWith('<')) { // XML ì‘ë‹µ ì˜ˆì™¸ ì²˜ë¦¬
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const errorMsgNode = xmlDoc.querySelector("returnReasonCode") || xmlDoc.querySelector("resultMsg");
                const errorMsg = errorMsgNode ? errorMsgNode.textContent : 'APIê°€ XML í˜•ì‹ì˜ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(`API ì˜¤ë¥˜ (${status}): ${errorMsg}`);
            }
            throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP ìƒíƒœ: ${status})`);
        }
        
        const items = parseStockResponse(text, status); // ìƒíƒœ ì½”ë“œë„ ì „ë‹¬ (ë¡œê¹…ìš©)
        
        if (!items || items.length === 0) {
            showNotification('ì¡°íšŒëœ ì‹œì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning', `ì¢…ëª©: ${searchInput}, ê¸°ê°„: ${days}ì¼`);
            appState.historicalPrices = [];
            // appState.currentPrice = 0; // í˜„ì¬ê°€ë¥¼ ì´ˆê¸°í™”í• ì§€ëŠ” ì •ì±…ì— ë”°ë¼ ê²°ì •
            // dom.currentPriceInput.value = '';
        } else {
            const prices = items.filter(item => item.clpr && item.basDt).map(item => ({
                date: item.basDt, // YYYYMMDD í˜•ì‹
                price: parseFloat(item.clpr)
            })).sort((a,b) => a.date.localeCompare(b.date)); // ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬

            if (!prices.length) {
                showNotification('ìœ íš¨í•œ ì‹œì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ê°€ê²© ë˜ëŠ” ë‚ ì§œ ëˆ„ë½).', 'warning');
                appState.historicalPrices = [];
            } else {
                appState.historicalPrices = prices;
                const latest = prices[prices.length - 1];
                appState.currentPrice = latest.price; // APIì—ì„œ ê°€ì ¸ì˜¨ ìµœì‹  ì¢…ê°€ë¥¼ í˜„ì¬ê°€ë¡œ ì—…ë°ì´íŠ¸
                if (dom.currentPriceInput) dom.currentPriceInput.value = latest.price;

                // srtnCd (ë‹¨ì¶•ì½”ë“œ) ë˜ëŠ” itmsNm (ì¢…ëª©ëª…) ì°¾ê¸°
                const firstValidItem = items.find(item => item.srtnCd && item.itmsNm);
                appState.fetchedStockInfo = {
                    code: firstValidItem?.srtnCd || searchInput, // ì½”ë“œê°€ ì—†ìœ¼ë©´ ì…ë ¥ê°’ ì‚¬ìš©
                    name: firstValidItem?.itmsNm || (/\d{6}/.test(searchInput) ? 'ì¢…ëª©ëª… ì¡°íšŒì‹¤íŒ¨' : searchInput), // ì´ë¦„ì´ ì—†ìœ¼ë©´ ì…ë ¥ê°’ ì‚¬ìš©
                    price: latest.price,
                    date: latest.date
                };
                showNotification(`${appState.fetchedStockInfo.name}(${appState.fetchedStockInfo.code}) ${prices.length}ì¼ì¹˜ ì‹œì„¸ ë¡œë“œ ì™„ë£Œ. ìµœì‹  ì¢…ê°€: ${latest.price.toLocaleString()}ì› (${latest.date})`, 'success');
            }
        }
    } catch (err) {
        console.error("fetchHistoricalStockData error:", err);
        showNotification(`ì‹œì„¸ ì¡°íšŒ ì˜¤ë¥˜: ${err.message}`, 'error', err.stack);
        appState.historicalPrices = []; // ì˜¤ë¥˜ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
    } finally {
        if (dom.fetchPriceBtn) {
            dom.fetchPriceBtn.disabled = false;
            dom.fetchPriceBtn.textContent = 'ğŸ“ˆ ê¸°ê°„ì‹œì„¸ ì¡°íšŒ';
        }
    }
    recalculateAndUpdateUI(); // ë°ì´í„° ë³€ê²½ í›„ UI ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
}

function formatDate(date, offsetDays) {
    const d = new Date(date);
    d.setDate(d.getDate() + offsetDays);
    return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`;
}

function initializeFeeEventListeners() {
    ['buyFeeRateInput', 'sellFeeRateInput', 'taxRateInput'].forEach(key => {
        const inputElement = dom[key];
        if (inputElement) {
            inputElement.addEventListener('change', () => {
                loadSettings(); // ë³€ê²½ëœ ê°’ì„ appState.feesì— ë°˜ì˜
                recalculateAndUpdateUI(); // ìˆ˜ìˆ˜ë£Œ ë³€ê²½ ì‹œ ì¬ê³„ì‚° ë° UI ì—…ë°ì´íŠ¸
                showNotification('ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            });
        }
    });
}

function loadSettings() {
    if(!dom.buyFeeRateInput || !dom.sellFeeRateInput || !dom.taxRateInput) {
        console.warn("Fee input DOM elements not found during loadSettings.");
        // ê¸°ë³¸ê°’ìœ¼ë¡œ appState.fees ì„¤ì • (ì´ë¯¸ appState ì´ˆê¸°í™” ì‹œ ì„¤ì •ë¨)
        return;
    }
    appState.fees.buyRate = parseFloat(dom.buyFeeRateInput.value) / 100 || 0;
    appState.fees.sellRate = parseFloat(dom.sellFeeRateInput.value) / 100 || 0;
    appState.fees.taxRate = parseFloat(dom.taxRateInput.value) / 100 || 0;
}

function setFeesToZeroAndRecalculate() {
  if(!dom.buyFeeRateInput || !dom.sellFeeRateInput || !dom.taxRateInput) return;
  dom.buyFeeRateInput.value = '0'; dom.sellFeeRateInput.value = '0'; dom.taxRateInput.value = '0';
  loadSettings(); // ë³€ê²½ëœ ê°’ì„ appState.feesì— ë°˜ì˜
  recalculateAndUpdateUI(); 
  showNotification('ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆì´ 0%ë¡œ ì„¤ì •ë˜ì–´ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function updateAggregates() {
    let totalCost = 0; // ìˆ˜ìˆ˜ë£Œ í¬í•¨ ì´ ë§¤ìˆ˜ ë¹„ìš©
    let totalQty = 0;
    appState.purchases.forEach(p => {
        totalCost += p.costWithFee; // costWithFeeëŠ” ì´ë¯¸ ìˆ˜ìˆ˜ë£Œê°€ í¬í•¨ëœ ê¸ˆì•¡
        totalQty += p.amount;
    });
    appState.totalInvestedCost = totalCost;
    appState.totalAmount = totalQty;
    appState.avgBuyPrice = totalQty > 0 ? totalCost / totalQty : 0;
}

function renderSummary() {
    if (!dom.summaryResultDiv) return;
    if (appState.purchases.length === 0) {
        dom.summaryResultDiv.innerHTML = '<p>ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. â‘ ì—ì„œ ìµœì´ˆ ë§¤ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>';
        return;
    }
    dom.summaryResultDiv.innerHTML = `
        <p><strong>ì´ ë³´ìœ  ìˆ˜ëŸ‰:</strong> ${appState.totalAmount.toLocaleString()} ì£¼</p>
        <p><strong>ì´ íˆ¬ì ì›ê¸ˆ (ìˆ˜ìˆ˜ë£Œ í¬í•¨):</strong> ${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</p>
        <p><strong>í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£Œ í¬í•¨):</strong> ${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</p>
    `;
}

function renderPurchaseHistoryTable() {
    if (!dom.purchaseHistoryTableContainer) return;
    if (appState.purchases.length === 0) {
        dom.purchaseHistoryTableContainer.innerHTML = '<p>ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    let tableHTML = '<table><thead><tr><th>êµ¬ë¶„</th><th>ë§¤ìˆ˜ê°€(ì›)</th><th>ìˆ˜ëŸ‰(ì£¼)</th><th>ë§¤ìˆ˜ê¸ˆì•¡(ì›)</th><th>ìˆ˜ìˆ˜ë£Œ(ì›)</th><th>ì´ ë¹„ìš©(ì›)</th><th>ëˆ„ì  í‰ë‹¨ê°€(ì›)</th></tr></thead><tbody>';
    let cumulativeCost = 0;
    let cumulativeAmount = 0;
    appState.purchases.forEach((p, index) => {
        const purchaseCostBeforeFee = p.price * p.amount;
        const fee = p.costWithFee - purchaseCostBeforeFee;
        cumulativeCost += p.costWithFee;
        cumulativeAmount += p.amount;
        const currentAvgPrice = cumulativeAmount > 0 ? cumulativeCost / cumulativeAmount : 0;
        tableHTML += `
            <tr>
                <td>${index === 0 ? 'ìµœì´ˆ' : `ì¶”ê°€ ${index}`}</td>
                <td>${p.price.toLocaleString()}</td>
                <td>${p.amount.toLocaleString()}</td>
                <td>${purchaseCostBeforeFee.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:0})}</td>
                <td>${fee.toLocaleString('ko-KR', {minimumFractionDigits:2, maximumFractionDigits:4})}</td>
                <td>${p.costWithFee.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})}</td>
                <td>${currentAvgPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})}</td>
            </tr>
        `;
    });
    tableHTML += '</tbody></table>';
    dom.purchaseHistoryTableContainer.innerHTML = tableHTML;
}

function recalculateAndUpdateUI() {
    updateAggregates();
    renderSummary();
    renderPurchaseHistoryTable();
    updateCharts(); // ëª¨ë“  ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
}

function initializeCharts() {
    if (typeof Chart === 'undefined') {
        console.error("Chart object is not defined. Cannot initialize charts.");
        showNotification('ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¼ë¶€ ì°¨íŠ¸ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    if (typeof ChartJsPluginAnnotation === 'undefined') {
        console.warn("ChartJsPluginAnnotation is not defined. Annotation features will be limited.");
    }

    if (dom.avgPriceChartCanvas && !avgPriceChartInstance) {
        avgPriceChartInstance = new Chart(dom.avgPriceChartCanvas.getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: createChartOptions('line', 'ğŸ“ˆ í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ ë° ê°œë³„ ë§¤ìˆ˜ê°€')
        });
    }

    if (dom.volumeChartCanvas && !volumeChartInstance) {
        volumeChartInstance = new Chart(dom.volumeChartCanvas.getContext('2d'), {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: createChartOptions('bar', 'ğŸ“Š ë§¤ìˆ˜ íšŒì°¨ë³„ ìˆ˜ëŸ‰', { plugins: { legend: { display: false } } })
        });
    }

    if (dom.investmentPieChartCanvas && !investmentPieChartInstance) {
        investmentPieChartInstance = new Chart(dom.investmentPieChartCanvas.getContext('2d'), {
            type: 'pie',
            data: { labels: [], datasets: [{ label: 'ë§¤ìˆ˜ ê¸ˆì•¡ ë¹„ì¤‘', data: [], backgroundColor: [], borderColor: [], borderWidth: 1 }] },
            options: createChartOptions('pie', 'ğŸ’° ë§¤ìˆ˜ ê±´ë³„ ê¸ˆì•¡ ë¹„ì¤‘ (%)', { plugins: { legend: { position: 'top' } } })
        });
        if (dom.investmentPieChartCanvas) dom.investmentPieChartCanvas.style.display = 'none';
    }

    if (dom.priceComparisonChartCanvas && !historicalPriceChartInstance) {
        const annotationPluginOptions = (typeof ChartJsPluginAnnotation !== 'undefined') ? {
            annotation: {
                annotations: {
                    avgBuyPriceLine: {
                        type: 'line', display: false, yMin: 0, yMax: 0, borderColor: 'orange', borderWidth: 2, borderDash: [6, 6],
                        label: { enabled: true, content: 'ë‚˜ì˜ í‰ë‹¨ê°€: 0ì›', position: 'end', backgroundColor: 'rgba(255,159,64,0.7)', color: 'white', font: { size: 10 }, padding: { top: 3, bottom: 3, left: 5, right: 5 }, yAdjust: -10 }
                    }
                }
            }
        } : {};

        historicalPriceChartInstance = new Chart(dom.priceComparisonChartCanvas.getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [ { label: 'ì¼ë³„ ì¢…ê°€', data: [], borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.1, fill: false } ] },
            options: createChartOptions('historicalLine', 'ğŸ“Š ê¸°ê°„ë³„ ì¢…ê°€ ë° ë‚˜ì˜ í‰ê· ë‹¨ê°€', {
                plugins: { legend: { display: true, position: 'top' }, ...annotationPluginOptions }
            })
        });
        if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'none';
    }
    updateDarkModeUI(document.body.classList.contains('dark'));
}

function updateCharts() {
    if (!avgPriceChartInstance && !volumeChartInstance && !investmentPieChartInstance && !historicalPriceChartInstance) {
        // Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì°¨íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš°
        return;
    }
    const chartLabels = appState.purchases.map((p, i) => i === 0 ? `ìµœì´ˆ(${p.amount}ì£¼)` : `ì¶”ê°€${i}(${p.amount}ì£¼)`);

    if (avgPriceChartInstance) {
        const avgPricesData = []; let cumulativeCost = 0, cumulativeAmount = 0;
        appState.purchases.forEach(p => { cumulativeCost += p.costWithFee; cumulativeAmount += p.amount; avgPricesData.push(cumulativeAmount > 0 ? cumulativeCost / cumulativeAmount : 0); });
        const individualPurchaseData = appState.purchases.map((p, index) => ({ x: index, y: p.price })); // For scatter
        
        avgPriceChartInstance.data.labels = chartLabels;
        avgPriceChartInstance.data.datasets = [
            { label: 'í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€', data: avgPricesData, type: 'line', borderColor: 'rgba(255,99,132,1)', backgroundColor: 'rgba(255,99,132,0.2)', fill: false, tension: 0.1, order: 1 },
            { label: 'ê°œë³„ ë§¤ìˆ˜ê°€', data: individualPurchaseData.map((val, idx) => val.y) , // line ì°¨íŠ¸ì—ì„œëŠ” yê°’ë§Œ í•„ìš”. scatterë¡œ í•˜ë ¤ë©´ x,y ê°ì²´ ë°°ì—´.
              type: 'line', // ë˜ëŠ” 'scatter'
              borderColor: 'rgba(75,192,192,1)', 
              backgroundColor: 'rgba(75,192,192,0.7)', 
              pointRadius: 5, showLine: false, order: 0,
              // ë§Œì•½ scatterë¡œ í•˜ê³  xì¶•ì„ ê³µìœ í•˜ë ¤ë©´, labels ëŒ€ì‹  xê°’ì„ ì§ì ‘ ëª…ì‹œí•´ì•¼ í•  ìˆ˜ ìˆìŒ
            } 
        ];
        // Scatter ì‚¬ìš©ì‹œ xì¶• labels ëŒ€ì‹  datasets[1].data = individualPurchaseData; ( [{x:0, y:price0}, {x:1, y:price1}] )
        // í˜„ì¬ëŠ” labelsë¥¼ ê³µìœ í•˜ë¯€ë¡œ datasets[1].dataëŠ” ê°€ê²© ë°°ì—´ë§Œ ì „ë‹¬
         avgPriceChartInstance.data.datasets[1].data = individualPurchaseData.map(item => item.y);
         avgPriceChartInstance.data.datasets[1].type = 'scatter'; // ëª…ì‹œì ìœ¼ë¡œ scatter
        
        avgPriceChartInstance.update('none');
    }
    if (volumeChartInstance) {
        const amountsData = appState.purchases.map(p => p.amount);
        volumeChartInstance.data.labels = chartLabels;
        volumeChartInstance.data.datasets = [{ label: 'ë§¤ìˆ˜ ìˆ˜ëŸ‰', data: amountsData, backgroundColor: 'rgba(54,162,235,0.6)', borderColor: 'rgba(54,162,235,1)', borderWidth: 1, yAxisID: 'yAmount' }];
        // yì¶• ì½œë°±ì—ì„œ yAxisIDë¥¼ ì°¸ì¡°í•˜ë„ë¡ createChartOptions ìˆ˜ì • ë˜ëŠ” ì—¬ê¸°ì„œ yì¶• ì œëª© ë“± ì§ì ‘ ì„¤ì •
        if(volumeChartInstance.options.scales.y) { // ê¸°ì¡´ yì¶•ì´ ìˆë‹¤ë©´
            volumeChartInstance.options.scales.y.title.text = 'ìˆ˜ëŸ‰(ì£¼)';
            volumeChartInstance.options.scales.y.ticks.callback = function(value) { return value.toLocaleString() + ' ì£¼'; };
        } else { // yì¶•ì´ ì—†ë‹¤ë©´ (pieì—ì„œ ì™”ì„ê²½ìš° ë“±), ìƒˆë¡œ ì •ì˜
             volumeChartInstance.options.scales.y = {
                beginAtZero: true,
                title: { display: true, text: 'ìˆ˜ëŸ‰(ì£¼)', color: getChartTextColors().titleColor },
                ticks: { callback: function(value) { return value.toLocaleString() + ' ì£¼'; }, color: getChartTextColors().tickColor },
                grid: { color: getChartTextColors().gridColor }
            };
        }


        volumeChartInstance.update('none');
    }
    if (investmentPieChartInstance) {
        if (appState.purchases.length > 0) {
            const pieLabels = appState.purchases.map((p, i) => i === 0 ? `ìµœì´ˆ (${p.price.toLocaleString()}ì›, ${p.amount}ì£¼)` : `ì¶”ê°€ ${i} (${p.price.toLocaleString()}ì›, ${p.amount}ì£¼)`);
            const pieData = appState.purchases.map(p => p.costWithFee);
            const baseColors = ['rgba(255,99,132,0.7)','rgba(54,162,235,0.7)','rgba(255,206,86,0.7)','rgba(75,192,192,0.7)','rgba(153,102,255,0.7)','rgba(255,159,64,0.7)','rgba(199,199,199,0.7)','rgba(83,102,83,0.7)','rgba(150,50,90,0.7)','rgba(90,150,50,0.7)'];
            const backgroundColors = pieLabels.map((_, i) => baseColors[i % baseColors.length]); const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));
            investmentPieChartInstance.data.labels = pieLabels; investmentPieChartInstance.data.datasets[0].data = pieData;
            investmentPieChartInstance.data.datasets[0].backgroundColor = backgroundColors; investmentPieChartInstance.data.datasets[0].borderColor = borderColors;
            investmentPieChartInstance.update('none'); if (dom.investmentPieChartCanvas) dom.investmentPieChartCanvas.style.display = 'block';
        } else {
            investmentPieChartInstance.data.labels = []; investmentPieChartInstance.data.datasets[0].data = [];
            investmentPieChartInstance.update('none'); if (dom.investmentPieChartCanvas) dom.investmentPieChartCanvas.style.display = 'none';
        }
    }
    if (historicalPriceChartInstance) {
        if (appState.historicalPrices && appState.historicalPrices.length > 0) {
            const labels = appState.historicalPrices.map(item => {
                const year = item.date.substring(2, 4); const month = item.date.substring(4, 6); const day = item.date.substring(6, 8);
                return `${year}/${month}/${day}`; // ë‚ ì§œ í¬ë§· YY/MM/DD
            });
            const data = appState.historicalPrices.map(item => item.price);
            historicalPriceChartInstance.data.labels = labels;
            historicalPriceChartInstance.data.datasets[0].data = data;
            historicalPriceChartInstance.data.datasets[0].label = appState.fetchedStockInfo.name ? `${appState.fetchedStockInfo.name}(${appState.fetchedStockInfo.code}) ì¼ë³„ì¢…ê°€` : 'ì¼ë³„ ì¢…ê°€';
            
            if (historicalPriceChartInstance.options.plugins.annotation && historicalPriceChartInstance.options.plugins.annotation.annotations && historicalPriceChartInstance.options.plugins.annotation.annotations.avgBuyPriceLine) {
                const avgPriceAnnotation = historicalPriceChartInstance.options.plugins.annotation.annotations.avgBuyPriceLine;
                if (appState.purchases.length > 0 && appState.avgBuyPrice > 0) {
                    avgPriceAnnotation.display = true;
                    avgPriceAnnotation.yMin = appState.avgBuyPrice;
                    avgPriceAnnotation.yMax = appState.avgBuyPrice;
                    avgPriceAnnotation.label.content = `ë‚˜ì˜ í‰ë‹¨ê°€: ${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})}ì›`;
                } else { avgPriceAnnotation.display = false; }
            }
            historicalPriceChartInstance.update('none');
            if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'block';
        } else {
            historicalPriceChartInstance.data.labels = [];
            historicalPriceChartInstance.data.datasets[0].data = [];
            if (historicalPriceChartInstance.options.plugins.annotation && historicalPriceChartInstance.options.plugins.annotation.annotations && historicalPriceChartInstance.options.plugins.annotation.annotations.avgBuyPriceLine) {
                historicalPriceChartInstance.options.plugins.annotation.annotations.avgBuyPriceLine.display = false;
            }
            historicalPriceChartInstance.update('none');
            if (dom.priceComparisonChartCanvas) dom.priceComparisonChartCanvas.style.display = 'none';
        }
    }
}

function saveData() {
  if (!dom.initPriceInput || !dom.initAmountInput || !dom.currentPriceInput || !dom.targetROIInput ||  
      !dom.buyFeeRateInput || !dom.sellFeeRateInput || !dom.taxRateInput || !dom.stockCodeInput) {
    console.error("saveData: í•„ìˆ˜ DOM ìš”ì†Œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    showNotification('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: í•„ìˆ˜ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  // appState.profitCalculationResultsì™€ appState.targetPriceCalculationResultsëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ (ì„¸ì…˜ ë°ì´í„°ë¡œ ê°„ì£¼)
  const { profitCalculationResults, targetPriceCalculationResults, ...appStateToSave } = appState;

  const dataToSave = {  
    appState: appStateToSave, // ê³„ì‚° ê²°ê³¼ ì œì™¸í•œ appState ì €ì¥
    inputs: {  
      initPrice: dom.initPriceInput.value, initAmount: dom.initAmountInput.value,  
      currentPrice: dom.currentPriceInput.value, targetROI: dom.targetROIInput.value,  
      buyFeeRate: dom.buyFeeRateInput.value, sellFeeRate: dom.sellFeeRateInput.value, taxRate: dom.taxRateInput.value,  
      stockCode: dom.stockCodeInput.value, historicalDays: dom.historicalDaysInput ? dom.historicalDaysInput.value : '90'
    }
  };
  localStorage.setItem(LS_KEY_DATA, JSON.stringify(dataToSave));
  showNotification('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function loadData() {
  const savedData = localStorage.getItem(LS_KEY_DATA);
  if (!savedData) {  
    resetAllData(false); // ì´ˆê¸°í™” (ì•Œë¦¼ ì—†ì´)
    return;  
  }
  
  let parsedData;
  try {
    parsedData = JSON.parse(savedData);
  } catch (error) {
    console.error("ì €ì¥ëœ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error);
    localStorage.removeItem(LS_KEY_DATA);  
    resetAllData(false); // ì˜¤ë¥˜ ì‹œ ì´ˆê¸°í™” (ì•Œë¦¼ ì—†ì´)
    showNotification('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™”í•©ë‹ˆë‹¤.', 'error', error.message);
    return;
  }

  if (parsedData.appState) {
      const defaultFeesFromDOM = {  
          buyRate: parseFloat(dom.buyFeeRateInput?.defaultValue || '0.015') / 100,  
          sellRate: parseFloat(dom.sellFeeRateInput?.defaultValue || '0.015') / 100,  
          taxRate: parseFloat(dom.taxRateInput?.defaultValue || '0.2') / 100  
      };
      // ì´ì „ ë²„ì „ í˜¸í™˜ì„± ë° ê¸°ë³¸ê°’ ì„¤ì •
      parsedData.appState.fees = parsedData.appState.fees || defaultFeesFromDOM;
      parsedData.appState.historicalPrices = parsedData.appState.historicalPrices || [];
      parsedData.appState.fetchedStockInfo = parsedData.appState.fetchedStockInfo || { code: '', name: '', price: 0, date: '' };
      
      appState = { ...appState, ...parsedData.appState }; // í˜„ì¬ appState ê¸°ë³¸ êµ¬ì¡°ì— ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ë³‘í•©
      // ì„¸ì…˜ ë°ì´í„°ì¸ ê³„ì‚° ê²°ê³¼ëŠ” í•­ìƒ nullë¡œ ì‹œì‘
      appState.profitCalculationResults = null;
      appState.targetPriceCalculationResults = null;

  } else { // appStateê°€ ì—†ëŠ” ë¹„ì •ìƒ ë°ì´í„°ë©´ ì´ˆê¸°í™”
      resetAllData(false); 
      showNotification('ì €ì¥ëœ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.', 'warning');
      return;
  }

  if (parsedData.inputs) {
      if(dom.initPriceInput) dom.initPriceInput.value = parsedData.inputs.initPrice || '';  
      if(dom.initAmountInput) dom.initAmountInput.value = parsedData.inputs.initAmount || '';
      if(dom.currentPriceInput) dom.currentPriceInput.value = parsedData.inputs.currentPrice || '';  
      if(dom.targetROIInput) dom.targetROIInput.value = parsedData.inputs.targetROI || '';
      if(dom.buyFeeRateInput) dom.buyFeeRateInput.value = parsedData.inputs.buyFeeRate !== undefined ? parsedData.inputs.buyFeeRate : (appState.fees.buyRate*100).toString();
      if(dom.sellFeeRateInput) dom.sellFeeRateInput.value = parsedData.inputs.sellFeeRate !== undefined ? parsedData.inputs.sellFeeRate : (appState.fees.sellRate*100).toString();
      if(dom.taxRateInput) dom.taxRateInput.value = parsedData.inputs.taxRate !== undefined ? parsedData.inputs.taxRate : (appState.fees.taxRate*100).toString();
      if(dom.stockCodeInput) dom.stockCodeInput.value = parsedData.inputs.stockCode || '';
      if(dom.historicalDaysInput && parsedData.inputs.historicalDays) dom.historicalDaysInput.value = parsedData.inputs.historicalDays;
  }
  
  loadSettings(); // input ê°’ì„ appState.feesì— ë°˜ì˜
  
  if(dom.additionalInputsContainer) dom.additionalInputsContainer.innerHTML = '';
  const additionalBuyBlocks = document.querySelectorAll('.buy-block'); // ì´ì „ UI ìš”ì†Œ ì œê±°
  additionalBuyBlocks.forEach(block => block.remove());

  if (appState.purchases && appState.purchases.length > 0) {
      if (dom.initPriceInput) dom.initPriceInput.value = appState.purchases[0].price;
      if (dom.initAmountInput) dom.initAmountInput.value = appState.purchases[0].amount;
      toggleInitialPurchaseInputs(true);

      appState.purchases.slice(1).forEach((p, i) => {
          if (!p.id) { p.id = `buyBlock-loaded-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;}
          const block = document.createElement('div'); block.className = 'buy-block'; block.id = p.id;
          block.innerHTML = `
              <div class="input-group"><label for="addPrice-${p.id}">ì¶”ê°€ ë§¤ìˆ˜ê°€ (${i+2}ì°¨)</label><input type="number" id="addPrice-${p.id}" value="${p.price}" disabled></div>
              <div class="input-group"><label for="addAmount-${p.id}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰ (${i+2}ì°¨)</label><input type="number" id="addAmount-${p.id}" value="${p.amount}" disabled></div>
              <button class="secondary" onclick="removeBuyBlockAndRecalculate('${p.id}')">âŒ ì´ í•­ëª© ì‚­ì œ</button>`;
          if(dom.additionalInputsContainer) dom.additionalInputsContainer.appendChild(block);
      });
  } else {
      toggleInitialPurchaseInputs(false);
  }
  
  // ì†ìµ ë° ëª©í‘œê°€ ê³„ì‚° ê²°ê³¼ UIëŠ” ì´ˆê¸°í™” (ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ê³„ì‚°í•˜ë„ë¡ ìœ ë„)
  clearProfitCalculation(); // appState.profitCalculationResultsë„ nullë¡œ ì„¤ì •
  clearTargetPriceCalculation(); // appState.targetPriceCalculationResultsë„ nullë¡œ ì„¤ì •

  recalculateAndUpdateUI(); // ì°¨íŠ¸ í¬í•¨ ì „ì²´ UI ì—…ë°ì´íŠ¸
  showNotification('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
}


function removeBuyBlockAndRecalculate(purchaseIdToRemove) {
    const purchaseIndex = appState.purchases.findIndex(p => p.id === purchaseIdToRemove);
    if (purchaseIndex > -1) {
        appState.purchases.splice(purchaseIndex, 1);
        
        if(dom.additionalInputsContainer) dom.additionalInputsContainer.innerHTML = ''; // Clear current blocks

        if (appState.purchases.length === 0) {
            clearInitialPurchase(); // ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥ì¹¸ í™œì„±í™” ë° ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
        } else {
            // ìµœì´ˆ ë§¤ìˆ˜ UI ì—…ë°ì´íŠ¸ (ë§Œì•½ ì²«ë²ˆì§¸ í•­ëª©ì´ ì‚­ì œëœ ê²½ìš° - ì‹¤ì œë¡œëŠ” ì¶”ê°€ë§¤ìˆ˜ ì‚­ì œì´ë¯€ë¡œ ì´ ë¡œì§ì€ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ)
            if (dom.initPriceInput) dom.initPriceInput.value = appState.purchases[0].price;
            if (dom.initAmountInput) dom.initAmountInput.value = appState.purchases[0].amount;
            toggleInitialPurchaseInputs(true); // ìµœì´ˆ ë§¤ìˆ˜ëŠ” ì—¬ì „íˆ ì…ë ¥ëœ ìƒíƒœ

            // ë‚˜ë¨¸ì§€ ì¶”ê°€ ë§¤ìˆ˜ UI ì¬ìƒì„±
            appState.purchases.slice(1).forEach((p, i) => {
                const block = document.createElement('div'); block.className = 'buy-block'; block.id = p.id;
                block.innerHTML = `
                    <div class="input-group"><label for="addPrice-${p.id}">ì¶”ê°€ ë§¤ìˆ˜ê°€ (${i+2}ì°¨)</label><input type="number" id="addPrice-${p.id}" value="${p.price}" disabled></div>
                    <div class="input-group"><label for="addAmount-${p.id}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰ (${i+2}ì°¨)</label><input type="number" id="addAmount-${p.id}" value="${p.amount}" disabled></div>
                    <button class="secondary" onclick="removeBuyBlockAndRecalculate('${p.id}')">âŒ ì´ í•­ëª© ì‚­ì œ</button>`;
                if(dom.additionalInputsContainer) dom.additionalInputsContainer.appendChild(block);
            });
        }
        clearProfitAndTargetCalculationsStateAndUI(); // ì‚­ì œ ì‹œ ê´€ë ¨ ê³„ì‚° ê²°ê³¼ë„ ì´ˆê¸°í™”
        recalculateAndUpdateUI();
        showNotification('ë§¤ìˆ˜ í•­ëª©ì´ ì‚­ì œë˜ê³  ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
}

function clearProfitAndTargetCalculationsStateAndUI() {
    appState.profitCalculationResults = null;
    appState.targetPriceCalculationResults = null;
    if(dom.profitResultTableDiv) dom.profitResultTableDiv.innerHTML = '';
    if(dom.breakEvenDiv) dom.breakEvenDiv.innerHTML = '';
    if(dom.targetPriceResultDiv) dom.targetPriceResultDiv.innerHTML = '';
    if(dom.targetPriceTableDiv) dom.targetPriceTableDiv.innerHTML = '';
}


function resetAllData(notify = true) {
  const defaultBuyFee = parseFloat(document.getElementById('buyFeeRate')?.defaultValue || '0.015') / 100;
  const defaultSellFee = parseFloat(document.getElementById('sellFeeRate')?.defaultValue || '0.015') / 100;
  const defaultTaxRate = parseFloat(document.getElementById('taxRate')?.defaultValue || '0.2') / 100;
  
  appState = {  
    purchases:[], avgBuyPrice:0, totalAmount:0, totalInvestedCost:0,  
    fees:{buyRate:defaultBuyFee, sellRate:defaultSellFee, taxRate:defaultTaxRate},  
    currentPrice:0, targetROI:0,  
    fetchedStockInfo:{code:'',name:'',price:0,date:''},
    historicalPrices: [],
    profitCalculationResults: null, // ì´ˆê¸°í™”
    targetPriceCalculationResults: null // ì´ˆê¸°í™”
  };

  if(dom.initPriceInput) dom.initPriceInput.value = '';  
  if(dom.initAmountInput) dom.initAmountInput.value = '';  
  toggleInitialPurchaseInputs(false);
  if(dom.additionalInputsContainer) dom.additionalInputsContainer.innerHTML = '';  
  if(dom.stockCodeInput) dom.stockCodeInput.value = '';
  if(dom.historicalDaysInput) dom.historicalDaysInput.value = '90';
  if(dom.currentPriceInput) dom.currentPriceInput.value = '';
  if(dom.targetROIInput) dom.targetROIInput.value = '';

  if(dom.buyFeeRateInput) dom.buyFeeRateInput.value = dom.buyFeeRateInput.defaultValue||'0.015';  
  if(dom.sellFeeRateInput) dom.sellFeeRateInput.value = dom.sellFeeRateInput.defaultValue||'0.015';  
  if(dom.taxRateInput) dom.taxRateInput.value = dom.taxRateInput.defaultValue||'0.2';
  
  clearProfitAndTargetCalculationsStateAndUI(); // ì†ìµ/ëª©í‘œê°€ UI ë° ìƒíƒœ ì´ˆê¸°í™”
  recalculateAndUpdateUI();  

  if (notify && localStorage.getItem(LS_KEY_DATA)) {  
    localStorage.removeItem(LS_KEY_DATA);  
    showNotification('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');  
  } else if (notify === false && !localStorage.getItem(LS_KEY_DATA)) {
    // ìµœì´ˆ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ì—†ì„ ë•Œ ì•Œë¦¼
    showNotification('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.', 'info');
  }
}

function downloadExcel() {
  if (appState.purchases.length === 0 && appState.historicalPrices.length === 0 && !appState.profitCalculationResults && !appState.targetPriceCalculationResults) {
    showNotification('ì—‘ì…€ë¡œ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');  
    return;  
  }
  const today = new Date();  
  const dateString = `${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}`;
  const fileName = `ë¬¼íƒ€ê¸°ê³„ì‚°_${dateString}.xlsx`;
  
  const ws_data = [
    ['í•­ëª©', 'ê°’', 'ë¹„ê³ '],
    ['ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œìœ¨ (%)', (appState.fees.buyRate * 100).toFixed(3), ''],
    ['ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%)', (appState.fees.sellRate * 100).toFixed(3), ''],
    ['ì„¸ê¸ˆìœ¨ (%)', (appState.fees.taxRate * 100).toFixed(3), ''],
    []  
  ];

  if (appState.purchases.length > 0) {
    ws_data.push(['ë§¤ìˆ˜ ë‚´ì—­']);
    ws_data.push(['êµ¬ë¶„', 'ë§¤ìˆ˜ê°€(ì›)', 'ìˆ˜ëŸ‰(ì£¼)', 'ë§¤ìˆ˜ê¸ˆì•¡(ìˆ˜ìˆ˜ë£Œí¬í•¨, ì›)', 'ëˆ„ì í‰ê· ë‹¨ê°€(ì›)']);
    let cumulativeTotalCost = 0, cumulativeTotalAmount = 0;
    appState.purchases.forEach((p, i) => {
      const costWithFee = p.costWithFee;  
      cumulativeTotalCost += costWithFee;  
      cumulativeTotalAmount += p.amount;
      const cumulativeAvgPrice = cumulativeTotalAmount > 0 ? cumulativeTotalCost / cumulativeTotalAmount : 0;
      const idDisplay = p.id ? (p.id.startsWith('buyBlock-') || p.id.startsWith('initial-') ? p.id.substring(p.id.indexOf('-') + 1, p.id.indexOf('-') + 9) : p.id.substring(0,8)) : 'N/A';
      ws_data.push([  
        i === 0 ? `ìµœì´ˆ ë§¤ìˆ˜ (ID: ${idDisplay})` : `ì¶”ê°€ ë§¤ìˆ˜ ${i} (ID: ${idDisplay})`,  
        p.price, p.amount, parseFloat(costWithFee.toFixed(2)), parseFloat(cumulativeAvgPrice.toFixed(2))  
      ]);
    });
    ws_data.push([]);  
    ws_data.push(['ë§¤ìˆ˜ ì´ê³„']);
    ws_data.push(['ì´ ë³´ìœ  ìˆ˜ëŸ‰ (ì£¼)', appState.totalAmount]);
    ws_data.push(['ì´ íˆ¬ì ì›ê¸ˆ (ìˆ˜ìˆ˜ë£Œ í¬í•¨, ì›)', parseFloat(appState.totalInvestedCost.toFixed(2))]);
    ws_data.push(['í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£Œ í¬í•¨, ì›)', parseFloat(appState.avgBuyPrice.toFixed(2))]);
    ws_data.push([]);  
  }

  if (appState.profitCalculationResults) {
    const results = appState.profitCalculationResults;
    ws_data.push(['ì†ìµ ê³„ì‚° ì •ë³´ (ê¸°ì¤€ê°€: ' + results.currentPrice.toLocaleString() + 'ì›)']);
    ws_data.push(['í˜„ì¬ í‰ê°€ ê¸ˆì•¡ (ì°¨ê° ì „)', parseFloat(results.grossMarketValue.toFixed(2))]);
    ws_data.push(['ì˜ˆìƒ ìˆœ í‰ê°€ ê¸ˆì•¡ (ì°¨ê° í›„)', parseFloat(results.netMarketValue.toFixed(2))]);
    ws_data.push(['ì˜ˆìƒ ìˆœì†ìµ', parseFloat(results.profitOrLoss.toFixed(2))]);
    ws_data.push(['ì˜ˆìƒ ìˆ˜ìµë¥  (%)', results.roi === Infinity ? 'âˆ' : parseFloat(results.roi.toFixed(2))]);
    ws_data.push(['ì†ìµë¶„ê¸°ì  ì£¼ê°€', results.breakEvenPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : parseFloat(results.breakEvenPrice.toFixed(2))]);
    ws_data.push([]);  
  } else {
    ws_data.push(['ì†ìµ ê³„ì‚° ì •ë³´', 'ì•„ì§ ê³„ì‚°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.']);
    ws_data.push([]);
  }

  if (appState.targetPriceCalculationResults) {
    const results = appState.targetPriceCalculationResults;
    ws_data.push(['ëª©í‘œ ìˆ˜ìµë¥  ê¸°ë°˜ ë§¤ë„ ê°€ê²© (ëª©í‘œ: ' + results.targetROI + '%)']);
    ws_data.push(['ëª©í‘œ ë§¤ë„ê°€', results.targetSellPricePerShare === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : parseFloat(results.targetSellPricePerShare.toFixed(2))]);
    ws_data.push(['ì˜ˆìƒ ìˆœìˆ˜ìµ ê¸ˆì•¡', parseFloat(results.targetNetProfit.toFixed(2))]);
    ws_data.push([]);  
  } else {
    ws_data.push(['ëª©í‘œ ìˆ˜ìµë¥  ê¸°ë°˜ ë§¤ë„ ê°€ê²©', 'ì•„ì§ ê³„ì‚°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.']);
    ws_data.push([]);
  }
  
  if (appState.historicalPrices && appState.historicalPrices.length > 0) {
    ws_data.push(['ê¸°ê°„ë³„ ì‹œì„¸ ë°ì´í„°']);
    ws_data.push([`${appState.fetchedStockInfo.name}(${appState.fetchedStockInfo.code})`]);
    ws_data.push(['ë‚ ì§œ', 'ì¢…ê°€']);
    appState.historicalPrices.forEach(item => {
      ws_data.push([item.date, item.price]);
    });
  }

  const wb = XLSX.utils.book_new();  
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  
  const colWidths = ws_data[0].map((_, i) => {
      let maxLen = 0;
      ws_data.forEach(row => {
          if (row[i] && String(row[i]).length > maxLen) {
              maxLen = String(row[i]).length;
          }
      });
      return { wch: Math.max(15, maxLen + 2) }; // ìµœì†Œ ë„ˆë¹„ 15, ë˜ëŠ” ë‚´ìš© + ì—¬ë°±
  });
  ws['!cols'] = colWidths;

  XLSX.utils.book_append_sheet(wb, ws, 'íˆ¬ìê³„ì‚°ë‚´ì—­');  
  XLSX.writeFile(wb, fileName);
  showNotification('ì—‘ì…€ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem(LS_KEY_DARK_MODE, isDark ? 'on' : 'off');
  updateDarkModeUI(isDark);
}

function updateDarkModeUI(isDark) {
    if(!dom.darkModeBtn) return;
    dom.darkModeBtn.innerText = isDark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ON' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON';
    
    if (typeof Chart === 'undefined' || (!avgPriceChartInstance && !volumeChartInstance && !investmentPieChartInstance && !historicalPriceChartInstance)) return;

    const colors = getChartTextColors(); // ì´ í•¨ìˆ˜ê°€ isDark ìƒíƒœë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ë°˜ì˜í•´ì•¼ í•¨ (body class ì²´í¬)
    
    const chartInstances = [avgPriceChartInstance, volumeChartInstance, investmentPieChartInstance, historicalPriceChartInstance].filter(Boolean);
    
    chartInstances.forEach(chart => {
        if (chart.options) {  
            if(chart.options.plugins && chart.options.plugins.title) chart.options.plugins.title.color = colors.titleColor;
            if(chart.options.plugins && chart.options.plugins.legend) chart.options.plugins.legend.labels.color = colors.legendColor;
            if(chart.options.scales){
                if(chart.options.scales.x){ chart.options.scales.x.ticks.color = colors.tickColor; chart.options.scales.x.grid.color = colors.gridColor; if(chart.options.scales.x.title) chart.options.scales.x.title.color = colors.titleColor; }
                if(chart.options.scales.y){ chart.options.scales.y.ticks.color = colors.tickColor; chart.options.scales.y.grid.color = colors.gridColor; if(chart.options.scales.y.title) chart.options.scales.y.title.color = colors.titleColor; }
            }
            if (chart.options.plugins && chart.options.plugins.annotation && chart.options.plugins.annotation.annotations) {
                Object.values(chart.options.plugins.annotation.annotations).forEach(annotation => {
                    if (annotation.label) {
                        // ì˜ˆì‹œ: ë‚˜ì˜ í‰ë‹¨ê°€ ë¼ë²¨ ìƒ‰ìƒ ì¡°ì •
                        if (annotation.label.content && annotation.label.content.startsWith('ë‚˜ì˜ í‰ë‹¨ê°€')) {
                             annotation.label.backgroundColor = isDark ? 'rgba(100,100,100,0.7)' : 'rgba(255,159,64,0.7)'; // ì–´ë‘ìš´/ë°ì€ ì£¼í™©ìƒ‰ ê³„ì—´
                             annotation.label.color = isDark ? '#f0f0f0' : 'white';
                        }
                    }
                });
            }
            chart.update('none'); // ë¶€ë“œëŸ¬ìš´ ì—…ë°ì´íŠ¸ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜
        }
    });
}

let nextBuyBlockIdSuffix = 0;
function generateBuyBlockId() {
    return `buyBlock-${Date.now()}-${nextBuyBlockIdSuffix++}`;
}

function setInitialPurchase() {
    if (!dom.initPriceInput || !dom.initAmountInput) return;
    const price = parseFloat(dom.initPriceInput.value);
    const amount = parseInt(dom.initAmountInput.value);

    if (isNaN(price) || price <= 0 || isNaN(amount) || amount <= 0) {
        showNotification('ìµœì´ˆ ë§¤ìˆ˜ê°€ì™€ ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
    }
    const costWithFee = price * amount * (1 + appState.fees.buyRate);
    const purchaseId = `initial-${Date.now()}`; // ê³ ìœ  ID ìƒì„±
    appState.purchases = [{ id: purchaseId, price, amount, costWithFee }];
    
    toggleInitialPurchaseInputs(true);
    clearProfitAndTargetCalculationsStateAndUI(); // ê³„ì‚° ê²°ê³¼ ì´ˆê¸°í™”
    recalculateAndUpdateUI();
    showNotification('ìµœì´ˆ ë§¤ìˆ˜ ë‚´ì—­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function clearInitialPurchase() {
    if (!dom.initPriceInput || !dom.initAmountInput) return;
    dom.initPriceInput.value = '';
    dom.initAmountInput.value = '';
    appState.purchases = []; 
    if (dom.additionalInputsContainer) dom.additionalInputsContainer.innerHTML = ''; 
    toggleInitialPurchaseInputs(false);
    clearProfitAndTargetCalculationsStateAndUI();
    recalculateAndUpdateUI();
    showNotification('ìµœì´ˆ ë§¤ìˆ˜ ë‚´ì—­ ë° ëª¨ë“  ì¶”ê°€ ë§¤ìˆ˜ ë‚´ì—­ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function toggleInitialPurchaseInputs(disabled) {
    if (dom.initPriceInput) dom.initPriceInput.disabled = disabled;
    if (dom.initAmountInput) dom.initAmountInput.disabled = disabled;
    if (dom.setInitialPurchaseBtn) dom.setInitialPurchaseBtn.disabled = disabled;
    if (dom.clearInitialPurchaseBtn) dom.clearInitialPurchaseBtn.style.display = disabled ? 'inline-block' : 'none';
    if (dom.setInitialPurchaseBtn) dom.setInitialPurchaseBtn.textContent = disabled ? 'âœ” ìµœì´ˆ ë§¤ìˆ˜ ë°˜ì˜ë¨' : 'âœ” ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥';
}


function addBuyBlock() {
    if (appState.purchases.length === 0 && dom.initPriceInput && dom.initAmountInput && (dom.initPriceInput.value === '' || dom.initAmountInput.value === '')) {
         showNotification('â‘  ìµœì´ˆ ë§¤ìˆ˜ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ë°˜ì˜í•´ì£¼ì„¸ìš”.', 'warning');
         if (dom.initPriceInput) dom.initPriceInput.focus();
         return;
    }
    if (appState.purchases.length === 0 && dom.setInitialPurchaseBtn && !dom.setInitialPurchaseBtn.disabled) {
         showNotification('â‘  ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¨¼ì € ë°˜ì˜í•´ì£¼ì„¸ìš”.', 'warning');
         return;
    }

    if (!dom.additionalInputsContainer) return;
    const blockId = generateBuyBlockId();
    const newBlock = document.createElement('div');
    newBlock.className = 'buy-block';
    newBlock.id = blockId;
    const nextPurchaseOrder = appState.purchases.length + 1;
    newBlock.innerHTML = `
        <h4>${nextPurchaseOrder}ì°¨ ë§¤ìˆ˜ (ì¶”ê°€)</h4>
        <div class="input-group">
            <label for="addPrice-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ê°€ (ì›)</label>
            <input type="number" id="addPrice-${blockId}" min="0">
        </div>
        <div class="input-group">
            <label for="addAmount-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label>
            <input type="number" id="addAmount-${blockId}" min="1">
        </div>
        <button onclick="applyAdditionalPurchase('${blockId}')">â• ì´ ë§¤ìˆ˜ ë°˜ì˜</button>
        <button class="secondary" onclick="removeUnappliedBuyBlock(this.parentElement)">âŒ í•­ëª© ì œê±°</button>
    `;
    dom.additionalInputsContainer.appendChild(newBlock);
    document.getElementById(`addPrice-${blockId}`).focus();
}

function applyAdditionalPurchase(blockId) {
    const priceInput = document.getElementById(`addPrice-${blockId}`);
    const amountInput = document.getElementById(`addAmount-${blockId}`);
    const price = parseFloat(priceInput.value);
    const amount = parseInt(amountInput.value);

    if (isNaN(price) || price <= 0 || isNaN(amount) || amount <= 0) {
        showNotification('ì¶”ê°€ ë§¤ìˆ˜ê°€ì™€ ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
    }
    const costWithFee = price * amount * (1 + appState.fees.buyRate);
    appState.purchases.push({ id: blockId, price, amount, costWithFee }); // blockIdë¥¼ purchaseì˜ idë¡œ ì‚¬ìš©
    
    priceInput.disabled = true;
    amountInput.disabled = true;
    const blockElement = document.getElementById(blockId);
    const applyButton = blockElement.querySelector('button'); // ì²«ë²ˆì§¸ ë²„íŠ¼ (ë°˜ì˜ ë²„íŠ¼)
    if (applyButton) {
      applyButton.textContent = 'âœ… ë°˜ì˜ë¨';
      applyButton.disabled = true;
    }
    const removeButton = blockElement.querySelectorAll('button')[1]; // ë‘ë²ˆì§¸ ë²„íŠ¼ (ì œê±° ë²„íŠ¼)
    if (removeButton) {
      removeButton.textContent = 'âŒ ë°˜ì˜ëœ í•­ëª© ì‚­ì œ';
      // ì´ì œ ì´ ë²„íŠ¼ì€ 'ë°˜ì˜ëœ' í•­ëª©ì„ ì‚­ì œí•˜ë¯€ë¡œ removeBuyBlockAndRecalculate í˜¸ì¶œ
      removeButton.onclick = function() { removeBuyBlockAndRecalculate(blockId); };
    }
    
    clearProfitAndTargetCalculationsStateAndUI();
    recalculateAndUpdateUI();
    showNotification('ì¶”ê°€ ë§¤ìˆ˜ ë‚´ì—­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// ë¯¸ë°˜ì˜ëœ ì¶”ê°€ ë§¤ìˆ˜ UI ë¸”ë¡ë§Œ ì œê±°í•˜ëŠ” í•¨ìˆ˜
function removeUnappliedBuyBlock(blockElement) {
    if (blockElement && blockElement.parentElement === dom.additionalInputsContainer) {
        // ì‹¤ì œë¡œ appState.purchasesì— ì¶”ê°€ë˜ì§€ ì•Šì€ UI ë¸”ë¡ì¸ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì€ ë¶ˆí•„ìš”.
        // ì´ í•¨ìˆ˜ëŠ” 'í•­ëª© ì œê±°' ë²„íŠ¼ì— ì˜í•´ í˜¸ì¶œë˜ë©°, ì´ ë²„íŠ¼ì€ applyAdditionalPurchase í›„ ë³€ê²½ë¨.
        blockElement.remove();
        showNotification('ì¶”ê°€ ë§¤ìˆ˜ í•­ëª©ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
}


function clearAdditionalBuys() {
    if (dom.additionalInputsContainer) dom.additionalInputsContainer.innerHTML = '';
    if (appState.purchases.length > 1) { // ìµœì´ˆ ë§¤ìˆ˜(appState.purchases[0])ëŠ” ë‚¨ê¹€
        appState.purchases = appState.purchases.slice(0, 1);
    } else if (appState.purchases.length === 1 && dom.initPriceInput && dom.initPriceInput.disabled) {
        // ìµœì´ˆ ë§¤ìˆ˜ë§Œ ìˆê³ , ì¶”ê°€ë§¤ìˆ˜ í•­ëª©ì€ UIì—ë§Œ ìˆì—ˆë˜ ê²½ìš°, purchasesëŠ” ë³€ê²½ ì—†ìŒ
    } else {
        // ìµœì´ˆ ë§¤ìˆ˜ë„ ì—†ê±°ë‚˜ ì•„ì§ ë°˜ì˜ ì „ì´ë©´ purchasesëŠ” ë¹„ì–´ìˆê±°ë‚˜ ë¹„ì›Œì•¼ í•¨
        // clearInitialPurchaseê°€ ì´ ê²½ìš°ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì¶”ê°€ UIë§Œ ì •ë¦¬
    }
    clearProfitAndTargetCalculationsStateAndUI();
    recalculateAndUpdateUI();
    showNotification('ëª¨ë“  ì¶”ê°€ ë§¤ìˆ˜ í•­ëª©(UI)ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°˜ì˜ëœ ë‚´ì—­ì€ ìœ ì§€ ë˜ëŠ” ìµœì´ˆë§¤ìˆ˜ë§Œ ë‚¨ìŒ)', 'info');
}

function calculateProfit() {
    if (!dom.currentPriceInput) return;
    // ìµœì´ˆ ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìœ¼ë©´ ê³„ì‚° ë¶ˆê°€
    if (appState.purchases.length === 0) {
        showNotification('ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë§¤ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        clearProfitCalculation(); // UI ë° ê´€ë ¨ appState ì´ˆê¸°í™”
        return;
    }

    const currentPriceStr = dom.currentPriceInput.value;
    // í˜„ì¬ê°€ ì…ë ¥ì´ ë¹„ì–´ìˆê³ , APIë¡œ ê°€ì ¸ì˜¨ fetchedStockInfo.priceë„ ì—†ë‹¤ë©´ ê³„ì‚° ë¶ˆê°€ (ë˜ëŠ” appState.currentPrice ì‚¬ìš©)
    if (currentPriceStr === '' && !appState.fetchedStockInfo.price && !appState.currentPrice) {
        showNotification('í˜„ì¬(ê¸°ì¤€) ì£¼ê°€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ê¸°ê°„ì‹œì„¸ ì¡°íšŒë¥¼ ì´ìš©í•˜ì„¸ìš”.', 'error');
        clearProfitCalculation();
        return;
    }
    
    // ì…ë ¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ appState.currentPrice (API ì¡°íšŒê°’ ë“±), ê·¸ê²ƒë„ ì—†ìœ¼ë©´ 0
    const currentPrice = parseFloat(currentPriceStr) || appState.currentPrice || 0;

    if (isNaN(currentPrice) || currentPrice < 0) {
        showNotification('í˜„ì¬(ê¸°ì¤€) ì£¼ê°€ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        clearProfitCalculation();
        return;
    }
    // ê³„ì‚°ì— ì‚¬ìš©ëœ í˜„ì¬ê°€ë¥¼ appState.currentPriceì— ìµœì¢… ë°˜ì˜ (ì˜µì…˜)
    // appState.currentPrice = currentPrice;

    const grossMarketValue = currentPrice * appState.totalAmount;
    const sellFeeAmount = grossMarketValue * appState.fees.sellRate;
    const taxAmount = grossMarketValue * appState.fees.taxRate;
    const netMarketValue = grossMarketValue - sellFeeAmount - taxAmount;
    const profitOrLoss = netMarketValue - appState.totalInvestedCost;
    const roi = appState.totalInvestedCost > 0 ? (profitOrLoss / appState.totalInvestedCost) * 100 : (netMarketValue > 0 ? Infinity : 0);

    let breakEvenPrice = 0;
    if (appState.totalAmount > 0 && (1 - appState.fees.sellRate - appState.fees.taxRate) > 0) {
        breakEvenPrice = appState.totalInvestedCost / (appState.totalAmount * (1 - appState.fees.sellRate - appState.fees.taxRate));
    } else if (appState.totalAmount > 0) {
        breakEvenPrice = Infinity;
    }

    appState.profitCalculationResults = {
        currentPrice: currentPrice, grossMarketValue, sellFeeAmount, taxAmount, netMarketValue, profitOrLoss, roi, breakEvenPrice
    };

    if(dom.profitResultTableDiv) {
        const res = appState.profitCalculationResults;
        dom.profitResultTableDiv.innerHTML = `
            <h4>ì†ìµ ê³„ì‚° ê²°ê³¼ (ê¸°ì¤€ ì£¼ê°€: ${res.currentPrice.toLocaleString()} ì›)</h4>
            <table>
                <tr><td>ì´ ë³´ìœ  ìˆ˜ëŸ‰</td><td>${appState.totalAmount.toLocaleString()} ì£¼</td></tr>
                <tr><td>í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€</td><td>${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>ì´ íˆ¬ì ì›ê¸ˆ</td><td>${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>í˜„ì¬ í‰ê°€ ê¸ˆì•¡ (ì°¨ê° ì „)</td><td>${res.grossMarketValue.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>ì˜ˆìƒ ë§¤ë„ ìˆ˜ìˆ˜ë£Œ</td><td>-${res.sellFeeAmount.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì› (${(appState.fees.sellRate*100).toFixed(3)}%)</td></tr>
                <tr><td>ì˜ˆìƒ ì„¸ê¸ˆ</td><td>-${res.taxAmount.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì› (${(appState.fees.taxRate*100).toFixed(2)}%)</td></tr>
                <tr><td><strong>ì˜ˆìƒ ìˆœ í‰ê°€ ê¸ˆì•¡</strong></td><td><strong>${res.netMarketValue.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</strong></td></tr>
                <tr><td><strong>ì˜ˆìƒ ìˆœì†ìµ</strong></td><td class="${res.profitOrLoss >= 0 ? 'positive' : 'negative'}">${res.profitOrLoss.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td><strong>ì˜ˆìƒ ìˆ˜ìµë¥ </strong></td><td class="${res.roi >= 0 ? 'positive' : 'negative'}">${res.roi === Infinity ? 'âˆ' : res.roi.toFixed(2)}%</td></tr>
            </table>`;
    }
    if(dom.breakEvenDiv) {
        dom.breakEvenDiv.innerHTML = `ğŸ’¡ <strong>ì†ìµë¶„ê¸°ì  ì£¼ê°€ (BEP):</strong> ${appState.profitCalculationResults.breakEvenPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : appState.profitCalculationResults.breakEvenPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ì›'}`;
    }
    updateCharts();
}

function clearProfitCalculation() {
    if(dom.profitResultTableDiv) dom.profitResultTableDiv.innerHTML = '';
    if(dom.breakEvenDiv) dom.breakEvenDiv.innerHTML = '';
    appState.profitCalculationResults = null;
    // dom.currentPriceInput.value = ''; // í˜„ì¬ê°€ ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸°í™”í• ì§€ëŠ” ì„ íƒì‚¬í•­
}

function calculateTargetSellPrice() {
    if (!dom.targetROIInput) return;
    if (appState.purchases.length === 0) {
        showNotification('ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë§¤ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        clearTargetPriceCalculation();
        return;
    }
    const targetROIStr = dom.targetROIInput.value;
    if (targetROIStr === '') {
        showNotification('ëª©í‘œ ìˆ˜ìµë¥ ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        clearTargetPriceCalculation();
        return;
    }
    const currentTargetROI = parseFloat(targetROIStr); // ì…ë ¥ í•„ë“œì˜ ê°’ì„ ì‚¬ìš©
    if (isNaN(currentTargetROI)) { 
        showNotification('ëª©í‘œ ìˆ˜ìµë¥ ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        clearTargetPriceCalculation();
        return;
    }
    // appState.targetROI = currentTargetROI; // ê³„ì‚°ì— ì‚¬ìš©ëœ ê°’ì„ appStateì— ë°˜ì˜ (ì˜µì…˜)

    const targetNetProfit = appState.totalInvestedCost * (currentTargetROI / 100);
    const targetTotalNetReturn = appState.totalInvestedCost + targetNetProfit;
    let targetSellPricePerShare = 0;
    let targetGrossMarketValue = 0;

    if (appState.totalAmount > 0) {
        const denominator = appState.totalAmount * (1 - appState.fees.sellRate - appState.fees.taxRate);
        if (denominator > 0) {
            targetSellPricePerShare = targetTotalNetReturn / denominator;
            targetGrossMarketValue = targetSellPricePerShare * appState.totalAmount;
        } else {
            targetSellPricePerShare = Infinity; targetGrossMarketValue = Infinity;
        }
    }
    
    appState.targetPriceCalculationResults = {
        targetROI: currentTargetROI, targetNetProfit, targetTotalNetReturn, targetSellPricePerShare, targetGrossMarketValue
    };

    if(dom.targetPriceResultDiv) {
        const res = appState.targetPriceCalculationResults;
        dom.targetPriceResultDiv.innerHTML = `
            <h4>ëª©í‘œ ìˆ˜ìµë¥  (${res.targetROI}%) ë‹¬ì„±ì„ ìœ„í•œ ë§¤ë„ ê°€ê²©</h4>
            <p><strong>ëª©í‘œ ì£¼ë‹¹ ë§¤ë„ ê°€ê²©:</strong> ${res.targetSellPricePerShare === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : res.targetSellPricePerShare.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ì›'}</p>
            <p><strong>ì´ íˆ¬ì ì›ê¸ˆ:</strong> ${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</p>
            <p><strong>ëª©í‘œ ìˆœìˆ˜ìµ ê¸ˆì•¡:</strong> ${res.targetNetProfit.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</p>
            <p><strong>ë§¤ë„ ì‹œ ì´ ìˆœìˆ˜ë ¹ì•¡:</strong> ${res.targetTotalNetReturn.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</p>
            ${res.targetGrossMarketValue !== Infinity ? `<p><small>(ì°¸ê³ : ì´ë•Œ ì´ í‰ê°€ì•¡(ë§¤ë„ë¹„ìš© ì°¨ê° ì „)ì€ ì•½ ${res.targetGrossMarketValue.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›)</small></p>` : ''}`;
    }
    if(dom.targetPriceTableDiv && appState.targetPriceCalculationResults.targetSellPricePerShare !== Infinity) {
        const res = appState.targetPriceCalculationResults;
        const sellFeeAmountTarget = res.targetGrossMarketValue * appState.fees.sellRate;
        const taxAmountTarget = res.targetGrossMarketValue * appState.fees.taxRate;
        dom.targetPriceTableDiv.innerHTML = `
            <table>
                <tr><td>ì´ ë³´ìœ  ìˆ˜ëŸ‰</td><td>${appState.totalAmount.toLocaleString()} ì£¼</td></tr>
                <tr><td>í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€</td><td>${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>ëª©í‘œ ë§¤ë„ ê°€ê²© (ì£¼ë‹¹)</td><td>${res.targetSellPricePerShare.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>í‰ê°€ ê¸ˆì•¡ (ë§¤ë„ ë¹„ìš© ì°¨ê° ì „)</td><td>${res.targetGrossMarketValue.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>ì˜ˆìƒ ë§¤ë„ ìˆ˜ìˆ˜ë£Œ</td><td>-${sellFeeAmountTarget.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td>ì˜ˆìƒ ì„¸ê¸ˆ</td><td>-${taxAmountTarget.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td><strong>ì˜ˆìƒ ìˆœ í‰ê°€ ê¸ˆì•¡</strong></td><td><strong>${res.targetTotalNetReturn.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</strong></td></tr>
                <tr><td><strong>ì´ íˆ¬ì ì›ê¸ˆ</strong></td><td>-${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
                <tr><td><strong>ì˜ˆìƒ ìˆœì†ìµ (ëª©í‘œ ë‹¬ì„± ì‹œ)</strong></td><td class="positive">${res.targetNetProfit.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2})} ì›</td></tr>
            </table>`;
    } else if (dom.targetPriceTableDiv) {
        dom.targetPriceTableDiv.innerHTML = '';
    }
    updateCharts();
}

function clearTargetPriceCalculation() {
    if(dom.targetPriceResultDiv) dom.targetPriceResultDiv.innerHTML = '';
    if(dom.targetPriceTableDiv) dom.targetPriceTableDiv.innerHTML = '';
    appState.targetPriceCalculationResults = null;
    // dom.targetROIInput.value = ''; // ëª©í‘œ ìˆ˜ìµë¥  ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸°í™”í• ì§€ëŠ” ì„ íƒì‚¬í•­
}

</script>
</body>
</html>